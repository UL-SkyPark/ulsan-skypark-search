<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>울산하늘공원 안치 정보 관리</title>

  <link rel="icon" type="image/x-icon" href="./images/symbol.png">
  <link rel="apple-touch-icon" href="./images/symbol.png">

  <!-- Handsontable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <!-- XLSX (업로드 엑셀 읽기용) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;

      --line:#d1d5db;
      --line-soft:#e5e7eb;

      --primary:#2f6fb2;
      --primary-h:#285f98;

      --success:#0f766e;
      --warn:#b45309;
      --danger:#b42318;

      --shadow: 0 6px 14px rgba(17, 24, 39, 0.08);
      --radius:6px;
      --radius-sm:4px;

      --header:#eef2f7;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:18px;
      background: var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
        Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      display:flex;
      justify-content:center;
      font-size:15px;
    }

    .container{
      width:100%;
      max-width:1320px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: var(--header);
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .title{
      font-size:20px;
      font-weight:900;
      letter-spacing:-0.2px;
      margin:0;
      line-height:1.15;
    }

    /* ✅ 상단 제목 아래(meta-line) 숨김 */
    .meta-line{ display:none !important; }

    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
      flex-shrink:0;
    }
    .logo{
      height:38px;
      width:auto;
      display:block;
      filter: saturate(0.95) contrast(0.98);
    }

    .content{ padding:14px 16px 16px; }

    .top-panels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .top-panels{ grid-template-columns: 1fr; }
    }

    .box{
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      margin-bottom:12px;
    }

    /* ✅ 상단 2개 패널: 높이 동일 & 낮게 */
    .top-panels .box{
      margin-bottom:0;
      display:flex;
      flex-direction:column;
      height: 360px;              /* ✅ 두 창 동일 높이(낮게) */
      min-height: 360px;
    }

    .box-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
      margin-bottom:10px;
      color:#111827;
      font-size:15px;
      flex-shrink:0;
    }

    .row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:10px;
      margin:0;
    }

    .form-group label{
      display:block;
      font-weight:800;
      font-size:13px;
      margin-bottom:6px;
      color:#374151;
    }
    .form-group input{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background:#fff;
      font-size:14px;
      outline:none;
      transition:0.12s;
    }
    .form-group input:focus{
      border-color:#9bb9dd;
      box-shadow:0 0 0 3px rgba(47,111,178,0.14);
    }

    .field-help{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.35;
    }
    .field-help .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line-soft);
      background:#fff;
      color:#374151;
      font-weight:900;
      margin-right:6px;
      white-space:nowrap;
    }

    .toolbar{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      flex-shrink:0;
    }

    /* ✅ 상단 2패널: 내용이 남으면 toolbar가 아래 고정되도록 */
    .top-panels .box .toolbar{ margin-top:auto; }

    .btn{
      border:1px solid var(--line);
      padding:9px 12px;
      border-radius: var(--radius-sm);
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      transition:0.12s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#fff;
      color:#111827;
      min-height:36px;
    }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; }
    .btn:hover{ background:#f9fafb; }
    .btn:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(47,111,178,0.14); }

    .btn-primary{
      background: var(--primary);
      border-color: var(--primary);
      color:#fff;
    }
    .btn-primary:hover{ background: var(--primary-h); border-color: var(--primary-h); }

    .btn-ghost{ background:#fff; border-color: var(--line); color:#111827; }

    .icon-btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      padding:9px 10px;
      border-radius: var(--radius-sm);
      font-weight:800;
      cursor:pointer;
      transition:0.12s;
      white-space:nowrap;
      min-height:36px;
    }
    .icon-btn:hover{ background:#f9fafb; }

    .load-hint{
      display:none;
      font-size:13px;
      font-weight:900;
      color: var(--danger);
      padding:0;
      border:0;
      background:transparent;
      white-space:nowrap;
    }
    .blink-arrow{
      display:inline-block;
      margin-left:8px;
      font-weight:900;
      color: var(--danger);
      animation: blinkNudge 1s infinite;
    }
    @keyframes blinkNudge{
      0%, 100% { opacity: .15; transform: translateX(0); }
      50%      { opacity: 1;   transform: translateX(6px); }
    }

    .status{
      display:none;
      position: sticky;
      top: 10px;
      z-index: 50;
      margin:10px 0 12px;
      padding:10px 12px;
      border-radius: var(--radius-sm);
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      white-space:pre-wrap;
      font-size:14px;
      cursor:pointer;
    }
    .status.success{ border-color:#99f6e4; background:#f0fdfa; color:#134e4a; }
    .status.error{ border-color:#fecdd3; background:#fff1f2; color:#7f1d1d; }
    .status.loading{ background:#f8fafc; color:#374151; }

    .file-panel{
      border:1px solid var(--line-soft);
      background:#fafafa;
      border-radius: var(--radius-sm);
      padding:10px;
      transition:0.12s;
    }
    .file-panel.drop-ready{
      outline: 2px dashed rgba(47,111,178,0.35);
      outline-offset: 2px;
      background: #f3f7ff;
    }

    .file-panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .file-panel-title{
      font-size:13px;
      font-weight:900;
      color:#111827;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .count{
      font-weight:900;
      color:#111827;
      background:#fff;
      border:1px solid var(--line-soft);
      padding:2px 8px;
      border-radius: var(--radius-sm);
      white-space:nowrap;
      font-size:12px;
    }
    .file-panel-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .file-list{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .file-list li{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
      padding:7px 8px;
      background:#fff;
      border:1px solid var(--line-soft);
      border-radius: var(--radius-sm);
      font-size:13px;
      color:#111827;
    }
    .file-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .file-name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .file-sub{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .mono{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .x-btn{
      border:1px solid var(--line);
      background:#fff;
      color:#374151;
      width:28px;
      height:28px;
      border-radius: var(--radius-sm);
      cursor:pointer;
      font-weight:900;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .x-btn:hover{ background:#f9fafb; }

    .muted{ color:var(--muted); font-weight:800; }

    .grid-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      border-bottom:1px solid var(--line);
      padding-bottom:8px;
    }
    .tabs{
      display:inline-flex;
      gap:0;
      border:1px solid var(--line);
      border-bottom:0;
      background:#fff;
    }
    .tab-btn{
      border:0;
      background:#f9fafb;
      cursor:pointer;
      padding:9px 14px;
      font-weight:900;
      font-size:13px;
      color:#374151;
      border-right:1px solid var(--line);
      border-radius:0;
      min-width:110px;
    }
    .tab-btn:last-child{ border-right:0; }
    .tab-btn:disabled{ opacity:0.55; cursor:not-allowed; }
    .tab-btn.active{
      background:#fff;
      color:#111827;
      border-bottom:2px solid #fff;
    }
    .grid-meta{
      font-size:12px;
      color:#374151;
      font-weight:900;
      white-space:nowrap;
      padding-bottom:2px;
    }

    #hotContainer{
      width:100%;
      height:560px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    .hot-row-highlight{ background: rgba(47,111,178,0.12) !important; }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(17, 24, 39, 0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:1200px;
      background:#fff;
      border-radius: var(--radius);
      border:1px solid var(--line);
      box-shadow: 0 18px 60px rgba(17, 24, 39, 0.35);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#f8fafc;
    }
    .modal-title{
      font-size:14px;
      font-weight:900;
      margin:0;
      color:#111827;
    }
    .modal-body{
      padding:12px 14px;
      color:#111827;
      font-size:13px;
      line-height:1.5;
      max-height:72vh;
      overflow:auto;
    }
    .modal-foot{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      background:#fafafa;
    }

    .file-section{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      overflow:hidden;
      background:#fff;
    }
    .file-section-head{
      padding:10px 12px;
      background:#f3f4f6;
      border-bottom:1px solid var(--line-soft);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#111827;
      font-size:13px;
    }
    .file-section-head .mini{
      font-size:12px;
      color:#374151;
      font-weight:900;
      background:#fff;
      border:1px solid var(--line-soft);
      padding:2px 8px;
      border-radius: var(--radius-sm);
      white-space:nowrap;
    }

    table.q{
      width:100%;
      border-collapse:collapse;
      border:0;
      background:#fff;
      font-size:13px;
    }
    table.q th, table.q td{
      border-bottom:1px solid var(--line-soft);
      border-right:1px solid var(--line-soft);
      padding:8px 10px;
      text-align:left;
      vertical-align:top;
    }
    table.q th{
      background:#fafafa;
      font-weight:900;
      color:#374151;
    }
    table.q tr:last-child td{ border-bottom:0; }
    table.q th:last-child, table.q td:last-child{ border-right:0; }
    .danger{ color:var(--danger); font-weight:900; white-space:pre-wrap; }

    /* =========================================================
       ✅ 일괄등록 박스: 높이 낮춤 + 버튼이 바로 보이게
       ========================================================= */
    .bulk-box{ min-height:0; }

    /* 기존에 flex:1로 늘리던 구조를 줄여서, 드랍박스 높이 관리 */
    .bulk-box .form-group{
      display:flex;
      flex-direction:column;
      min-height:0;
      flex: 0 0 auto;   /* ✅ 과한 확장 방지 */
    }

    .bulk-box .file-panel{
      display:flex;
      flex-direction:column;
      min-height:0;
      margin-bottom: 10px; /* ✅ 여백 줄임 */
    }

    /* ✅ 드랍/목록 영역 자체 높이 낮춤 */
    .bulk-box #selectedFiles{
      min-height: 130px;     /* ✅ 낮게 */
      max-height: 130px;     /* ✅ 고정 느낌 */
      overflow:auto;
    }

    /* ✅ 도움말(ul) 자체가 높이 많이 먹어서 숨김 */
    .bulk-box .field-help{ display:none !important; }

    /* 버튼 상단 여백도 줄여서 바로 보이게 */
    .bulk-box .toolbar{ margin-top: 8px; }

    /* ✅ Access Token */
    .token-row{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:8px;
      align-items:center;
    }
    @media (max-width: 560px){
      .token-row{ grid-template-columns: 1fr 1fr; }
      .token-row input{ grid-column: 1 / -1; }
    }
    .token-persist{
      margin-top:10px;
      display:flex;
      align-items:flex-start;
    }
    .token-persist .token-check{
      display:inline-flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      cursor:pointer;
      width: fit-content;
      max-width:100%;
      margin:0;
      padding:0;
    }
    .token-persist .token-check input{ transform: translateY(1px); }
    .token-persist .token-label{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      white-space:nowrap;
    }
    .token-persist .token-inline-note{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 class="title">울산하늘공원 안치 정보 관리</h1>
        <div class="meta-line"></div>
      </div>
      <div class="header-right">
        <img class="logo" src="./images/ulsan_logo1.png" alt="울산 로고" />
      </div>
    </div>

    <div class="content">

      <div class="top-panels">

        <!-- ✅ 로그인 상태 -->
        <div class="box">
          <div class="box-title">
            <span>로그인 상태</span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-ghost" type="button" onclick="openLoginModal(true)">다시 로그인</button>
              <button id="resetAllBtn" class="btn btn-ghost" type="button"
                      onclick="resetAllSettings()"
                      title="Owner/Repo/Branch/Token 저장값을 초기화합니다">
                설정 초기화
              </button>
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label>Owner</label>
              <input type="text" id="infoOwner" readonly value="-" />
            </div>
            <div class="form-group">
              <label>Repo</label>
              <input type="text" id="infoRepo" readonly value="-" />
            </div>
            <div class="form-group">
              <label>Branch</label>
              <input type="text" id="infoBranch" readonly value="-" />
            </div>
            <div class="form-group">
              <label>마지막 로드</label>
              <input type="text" id="infoLoadedAt" readonly value="-" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>로드 현황</label>
              <input type="text" id="infoLoadedFiles" readonly value="-" />
              <div class="field-help">
                <span class="pill">안내</span> 데이터 사용/일괄등록은 <b>로드 완료 후</b> 활성화됩니다.
              </div>
            </div>
          </div>

          <div class="toolbar">
            <div id="loadHint" class="load-hint">먼저 ‘로그인(불러오기)’를 진행해 주세요.<span class="blink-arrow">➜</span></div>
          </div>
        </div>

        <!-- ✅ 일괄등록 -->
        <div class="box bulk-box">
          <div class="box-title">
            <span>일괄등록</span>
          </div>

          <div class="form-group">
            <input type="file" id="bulkFile" accept=".xlsx,.xls" multiple class="hidden" aria-label="일괄등록 엑셀 파일 선택" />

            <div class="file-panel" id="fileDropZone" title="이 박스에 파일을 끌어다 놓으시면 추가됩니다">
              <div class="file-panel-head">
                <div class="file-panel-title">
                  선택 파일 <span class="count" id="selectedFileCount">0</span>
                </div>
                <div class="file-panel-actions">
                  <button class="btn btn-ghost" id="pickFilesBtn" type="button" onclick="triggerFilePick()" disabled>파일 추가</button>
                  <button class="btn btn-ghost" id="bulkResetBtn" type="button" onclick="resetBulkUpload()" disabled>초기화</button>
                </div>
              </div>

              <div id="selectedFiles" class="muted">선택된 파일 없음</div>

              <!-- ✅ 요청대로 안내 문구 삭제 -->
            </div>
          </div>

          <div class="toolbar">
            <button class="btn btn-primary" id="bulkBtn" onclick="confirmAndImportBulkExcelAutoSave()" disabled>일괄등록</button>
          </div>
        </div>

      </div>

      <!-- 상태 (전체 폭) -->
      <div id="statusMsg" class="status" role="status" aria-live="polite" title="클릭하시면 닫힙니다"></div>

      <!-- 그리드(불러온 데이터) -->
      <div id="afterLoad" class="box" style="display:none;">
        <div class="grid-head">
          <div class="tabs" aria-label="대상 탭">
            <button id="tabDeceased" class="tab-btn active" onclick="selectTarget('deceased')">추모의집</button>
            <button id="tabNature" class="tab-btn" onclick="selectTarget('nature')">자연장지</button>
          </div>
          <div class="grid-meta" id="gridMeta">최근 20건 표시</div>
        </div>

        <div id="hotContainer"></div>
      </div>
    </div>
  </div>

  <!-- ✅ Login Modal (성공 전 닫기 불가) -->
  <div id="loginModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" style="max-width:720px;">
      <div class="modal-head">
        <div class="modal-title">GitHub 로그인(불러오기)</div>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="form-group">
            <label>GitHub Owner</label>
            <input type="text" id="owner" placeholder="예: UL-SkyPark" autocomplete="off" />
          </div>

          <div class="form-group">
            <label>Repository</label>
            <input type="text" id="repo" placeholder="예: ulsan-skypark-search" autocomplete="off" />
          </div>

          <div class="form-group">
            <label>Branch</label>
            <input type="text" id="branch" placeholder="예: main" autocomplete="off" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label>Access Token</label>

            <div class="token-row">
              <input type="password" id="token" placeholder="ghp_... 또는 fine-grained token" autocomplete="off" />
              <button type="button" class="icon-btn" id="tokenToggleBtn" onclick="toggleToken()">보기</button>
              <button type="button" class="icon-btn" id="clearTokenBtn" onclick="clearSavedToken()" title="브라우저에 저장된 토큰만 삭제합니다">
                저장토큰 삭제
              </button>
            </div>

            <div class="token-persist">
              <label class="token-check">
                <input type="checkbox" id="tokenPersist" checked />
                <span class="token-label">
                  이 브라우저에 토큰 저장
                  <span class="token-inline-note">※ 체크 해제 시(권장: 공용 PC) 브라우저를 닫으면 토큰이 사라집니다.</span>
                </span>
              </label>
            </div>

            <!-- ✅ 실패 알림(모달 내부) -->
            <div id="loginFailMsg" class="status error" style="display:none; margin-top:10px; cursor:default;"></div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn btn-primary" id="loginLoadBtn" onclick="loadAllFiles()">로그인(불러오기)</button>
      </div>
    </div>
  </div>

  <!-- ✅ Upload Result Modal -->
  <div id="resultModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" style="max-width:560px;">
      <div class="modal-head">
        <div class="modal-title" id="resultModalTitle">일괄등록 결과</div>
      </div>
      <div class="modal-body" id="resultModalBody"></div>
      <div class="modal-foot">
        <button class="btn btn-ghost" id="btnViewFailLog" onclick="openFailLogFromResult()" style="display:none;">
          실패로그 확인
        </button>
        <button class="btn btn-primary" onclick="closeResultModal()">확인</button>
      </div>
    </div>
  </div>

  <!-- Failure Log Modal -->
  <div id="logModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="logModalTitle">일괄등록 실패 로그</div>
      </div>
      <div class="modal-body" id="logModalBody"></div>
      <div class="modal-foot">
        <button class="btn btn-primary" onclick="closeLogModal()">확인</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal (일괄등록 확인) -->
  <div id="confirmModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" style="max-width:520px;">
      <div class="modal-head">
        <div class="modal-title">일괄등록 확인</div>
      </div>
      <div class="modal-body" id="confirmModalBody">
        일괄등록을 진행 하시겠습니까?<br>
        계속 하시려면 [확인], 취소하시려면 [취소]를 선택해 주세요.
      </div>
      <div class="modal-foot">
        <button class="btn btn-ghost" onclick="confirmBulkCancel()">취소</button>
        <button class="btn btn-primary" onclick="confirmBulkOk()">확인</button>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    //  ✅ JSON 기반 데이터 관리
    //    - GitHub에는 data/*.json 저장
    //    - 업로드 엑셀은 읽어서 내부 합친 뒤 JSON으로 PUT 저장
    // =========================================================

    // ===== 설정 =====
    const FILES = {
      deceased: "data/deceased_data.json",
      nature: "data/nature_data.json"
    };
    const GRID_LIMIT = 20;

    // ===== 상태 =====
    let hot = null;
    let fileKey = "deceased";
    let isBusy = false;
    let isLoaded = false;
    let loadedAtText = "";

    // 업로드 파일 상태
    let selectedFiles = []; // [{id, file}]
    let importFailLog = [];

    const DETECT_HINT = [
      "힌트(번호 규칙):",
      " - 추모의집: '...추모의집-62실-개인단-21908'",
      " - 자연장지: '잔디장-2-9-0108'",
      "판별 규칙(요약):",
      " - '추모의집' 또는 '00실' 포함 → 추모의집",
      " - '잔디장/수목장/자연장' 포함 또는 '이름-숫자-숫자-4자리' 형태 → 자연장지",
      " - 끝자리 숫자 5자리 → 추모의집 / 4자리 → 자연장지(보조)"
    ].join("\\n");

    // 데이터셋(2개 파일 동시 관리)
    const DATASETS = {
      deceased: { label: "추모의집", path: FILES.deceased, loaded:false, sha:"", headers:[], rows:[], highlight:new Set() },
      nature:   { label: "자연장지", path: FILES.nature,   loaded:false, sha:"", headers:[], rows:[], highlight:new Set() },
    };
    const ds = (k = fileKey) => DATASETS[k];

    // =========================================================
    //  유틸
    // =========================================================
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatLoadedAt(d){
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }
    function norm(s) {
      return String(s ?? "")
        .replace(/\\s+/g, "")
        .replace(/[–—]/g, "-")
        .toLowerCase();
    }
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeHtmlWithBr(s){
      return escapeHtml(s).replaceAll("\\n","<br>");
    }
    function formatBytes(bytes){
      const n = Number(bytes || 0);
      if (!isFinite(n) || n <= 0) return "0 B";
      const units = ["B","KB","MB","GB"];
      let v = n, i = 0;
      while (v >= 1024 && i < units.length - 1){ v = v / 1024; i++; }
      const fixed = (i === 0) ? String(Math.round(v)) : v.toFixed(1);
      return `${fixed} ${units[i]}`;
    }
    function normalizeDate(input) {
      const raw = String(input ?? "").trim();
      if (!raw) return "";
      const onlyNum = raw.replace(/[^0-9]/g, "");
      if (onlyNum.length === 8) {
        const y = onlyNum.slice(0,4), m = onlyNum.slice(4,6), d = onlyNum.slice(6,8);
        return `${y}-${m}-${d}`;
      }
      const cleaned = raw.replace(/\\./g, "-").replace(/\\//g, "-");
      const parts = cleaned.split("-").map(p => p.trim()).filter(Boolean);
      if (parts.length >= 3) {
        let [y,m,d] = parts;
        if (y.length === 2) y = "20" + y;
        m = String(parseInt(m,10)).padStart(2,"0");
        d = String(parseInt(d,10)).padStart(2,"0");
        if (!/^\\d{4}$/.test(y) || m === "NaN" || d === "NaN") return "";
        return `${y}-${m}-${d}`;
      }
      return "";
    }
    function findHeaderIndex(hs, candidates) {
      const list = hs.map(norm);
      for (const cand of candidates) {
        const idx = list.indexOf(norm(cand));
        if (idx !== -1) return idx;
      }
      return -1;
    }
    function getCellByHeader(rowObj, candidates) {
      const keys = Object.keys(rowObj || {});
      const map = new Map(keys.map(k => [norm(k), k]));
      for (const c of candidates) {
        const key = map.get(norm(c));
        if (key !== undefined) return rowObj[key];
      }
      return "";
    }
    function noHeaderCandidatesFor(key){
      return (key === "deceased")
        ? ["봉안번호","봉안 번호","봉안no","봉안No","번호","관리번호"]
        : ["자연장번호","자연장 번호","자연장no","자연장No","번호","관리번호","안장번호","안장 번호"];
    }

    // ✅ 업로드 "같은 행"에 부부/부부단/유사표현(= '부부' 포함)이 있으면 2명 허용
    function coupleFlagFromRow(rowObj){
      const v1 = String(getCellByHeader(rowObj, ["구분","구 분","단구분","단 구분","안장구분","안장 구분"])).trim();
      if (norm(v1).includes(norm("부부"))) return true;

      const allText = Object.entries(rowObj || {})
        .map(([k,v]) => `${String(k ?? "")}:${String(v ?? "")}`)
        .join(" ");

      return norm(allText).includes(norm("부부"));
    }

    // =========================================================
    //  상태/UX
    // =========================================================
    function showStatus(msg, type) {
      const el = document.getElementById("statusMsg");
      el.textContent = (msg || "") + "\\n(클릭하시면 닫힙니다)";
      el.className = "status " + type;
      el.style.display = "block";
      if (type === "success") setTimeout(() => (el.style.display = "none"), 2500);
    }
    document.getElementById("statusMsg")?.addEventListener("click", ()=>{
      const el = document.getElementById("statusMsg");
      el.style.display = "none";
    });

    function setBusy(b) {
      isBusy = b;
      document.getElementById("resetAllBtn").disabled = b;
      document.getElementById("loginLoadBtn").disabled = b;

      document.getElementById("bulkResetBtn").disabled = b || !isLoaded;
      document.getElementById("pickFilesBtn").disabled = b || !isLoaded;

      document.getElementById("tabDeceased").disabled = b || !isLoaded;
      document.getElementById("tabNature").disabled = b || !isLoaded;

      updateBulkButtonState();
    }

    function setLoaded(v){
      isLoaded = v;
      document.getElementById("afterLoad").style.display = v ? "block" : "none";
      showLoadHint(!v);

      document.getElementById("bulkResetBtn").disabled = !v || isBusy;
      document.getElementById("pickFilesBtn").disabled = !v || isBusy;

      document.getElementById("tabDeceased").disabled = !v || isBusy;
      document.getElementById("tabNature").disabled = !v || isBusy;

      updateBulkButtonState();
      setBusy(isBusy);
    }

    function showLoadHint(show){
      const el = document.getElementById("loadHint");
      el.style.display = show ? "inline-flex" : "none";
    }

    // ✅ 좌측 상단(로그인 상태 박스) 갱신
    function updateLoginInfoBox(show, loadedAt, loadedFilesText, branchText){
      const owner = document.getElementById("owner")?.value?.trim() || "-";
      const repo  = document.getElementById("repo")?.value?.trim() || "-";
      const branch= branchText || document.getElementById("branch")?.value?.trim() || "main";

      const setVal = (id, v) => {
        const el = document.getElementById(id);
        if (el) el.value = v || "-";
      };

      if (!show){
        setVal("infoOwner","-");
        setVal("infoRepo","-");
        setVal("infoBranch","-");
        setVal("infoLoadedAt","-");
        setVal("infoLoadedFiles","-");
        return;
      }

      setVal("infoOwner", owner);
      setVal("infoRepo", repo);
      setVal("infoBranch", branch);
      setVal("infoLoadedAt", loadedAt || "-");
      setVal("infoLoadedFiles", loadedFilesText || "-");
    }

    // =========================================================
    //  로그인 모달
    // =========================================================
    function openLoginModal(force=false){
      const back = document.getElementById("loginModalBackdrop");
      if (!back) return;
      if (force || !isLoaded){
        back.style.display = "flex";
        hideLoginFail();
      }
    }
    function closeLoginModal(){
      const back = document.getElementById("loginModalBackdrop");
      if (!back) return;
      back.style.display = "none";
    }
    function showLoginFail(msg){
      const el = document.getElementById("loginFailMsg");
      if (!el) return;
      el.textContent = msg || "로그인(불러오기)에 실패했습니다.";
      el.style.display = "block";
    }
    function hideLoginFail(){
      const el = document.getElementById("loginFailMsg");
      if (!el) return;
      el.style.display = "none";
    }

    // 토큰 저장 옵션
    function isTokenPersistEnabled(){
      return document.getElementById("tokenPersist")?.checked ?? true;
    }
    function toggleToken(){
      const input = document.getElementById("token");
      const btn = document.getElementById("tokenToggleBtn");
      if(!input || !btn) return;
      const isPw = input.type === "password";
      input.type = isPw ? "text" : "password";
      btn.textContent = isPw ? "가리기" : "보기";
    }
    function clearSavedToken(){
      localStorage.removeItem("gh_token");
      sessionStorage.removeItem("gh_token");
      const t = document.getElementById("token");
      if (t) t.value = "";
      showStatus("저장된 토큰을 삭제하였습니다(이 브라우저).", "success");
    }

    // =========================================================
    //  결과 모달(성공/실패)
    // =========================================================
    function openResultModal(html, hasFail){
      const back = document.getElementById("resultModalBackdrop");
      const body = document.getElementById("resultModalBody");
      const btn = document.getElementById("btnViewFailLog");
      if (!back || !body || !btn) return;

      body.innerHTML = html || "";
      btn.style.display = hasFail ? "inline-flex" : "none";
      back.style.display = "flex";
    }
    function closeResultModal(){
      const back = document.getElementById("resultModalBackdrop");
      if (back) back.style.display = "none";
    }
    function openFailLogFromResult(){
      closeResultModal();
      openLogModal("일괄등록 실패 로그");
    }
    document.getElementById("resultModalBackdrop")?.addEventListener("click", (e) => {
      if (e.target.id === "resultModalBackdrop") closeResultModal();
    });

    // =========================================================
    //  저장/로드 입력값 & 스토리지
    // =========================================================
    function getInputs() {
      const owner = document.getElementById("owner").value.trim();
      const repo  = document.getElementById("repo").value.trim();
      const token = document.getElementById("token").value.trim();
      const branch = (document.getElementById("branch").value.trim() || "main");
      return { owner, repo, token, branch };
    }
    function saveInputsToStorage({owner, repo, token, branch}) {
      const persist = isTokenPersistEnabled();
      localStorage.setItem("gh_owner", owner);
      localStorage.setItem("gh_repo", repo);
      localStorage.setItem("gh_branch", branch || "main");
      localStorage.setItem("gh_token_persist", persist ? "1" : "0");

      if (persist){
        localStorage.setItem("gh_token", token);
        sessionStorage.removeItem("gh_token");
      } else {
        sessionStorage.setItem("gh_token", token);
        localStorage.removeItem("gh_token");
      }
    }

    // =========================================================
    //  GitHub API (contents)
    // =========================================================
    function buildContentsUrl(owner, repo, path, branch) {
      return `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    }

    async function fetchJsonFromGitHub({owner, repo, token, branch}, path){
      const apiUrl = buildContentsUrl(owner, repo, path, branch);

      const metaRes = await fetch(apiUrl, {
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" }
      });
      if (!metaRes.ok) {
        const txt = await metaRes.text();
        throw new Error(`메타 조회 실패: ${path} (${metaRes.status})\n${txt}`);
      }
      const meta = await metaRes.json();
      if (Array.isArray(meta)) throw new Error(`경로가 폴더로 인식됨: ${path}`);
      if (!meta.download_url) throw new Error(`download_url 없음: ${path}`);

      const fileRes = await fetch(meta.download_url);
      if (!fileRes.ok) {
        const txt = await fileRes.text();
        throw new Error(`다운로드 실패: ${path} (${fileRes.status})\n${txt}`);
      }

      const data = await fileRes.json();
      return { sha: meta.sha || "", data };
    }

    function stringToBase64Utf8(str){
      const bytes = new TextEncoder().encode(str);
      let binary = "";
      const chunkSize = 0x8000;
      for (let i=0; i<bytes.length; i+=chunkSize){
        const chunk = bytes.subarray(i, i+chunkSize);
        binary += String.fromCharCode.apply(null, chunk);
      }
      return btoa(binary);
    }

    async function putJsonToGitHub(targetKey, jsonObj, message) {
      const inputs = getInputs();
      const { owner, repo, token, branch } = inputs;
      const d = ds(targetKey);

      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(d.path)}?ref=${encodeURIComponent(branch)}`;

      const jsonText = JSON.stringify(jsonObj, null, 2);
      const contentBase64 = stringToBase64Utf8(jsonText);

      const putBody = { message, content: contentBase64, branch };
      if (d.sha) putBody.sha = d.sha; // ✅ sha가 있을 때만 포함(신규 생성 지원)

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(putBody)
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`[${d.label}] 저장 실패 (${res.status})\n${txt}`);
      }

      const resData = await res.json();
      d.sha = resData.content?.sha || d.sha;
    }

    // =========================================================
    //  JSON 데이터셋 반영
    // =========================================================
    function normalizeLoadedDatasetFromJson(key, data){
      const d = ds(key);
      d.headers = Array.isArray(data?.headers) ? data.headers.map(x => String(x ?? "").trim()) : [];
      d.rows    = Array.isArray(data?.rows) ? data.rows : [];

      // 추모의집은 반환일자 컬럼 보장
      if (key === "deceased") {
        const idxReturn = findHeaderIndex(d.headers, ["반환일자","반환 일자","반환일"]);
        if (idxReturn === -1) d.headers.push("반환일자");
        for (const row of d.rows) while (row.length < d.headers.length) row.push("");
      }

      d.highlight = new Set();
      d.loaded = true;
    }

    // =========================================================
    //  Handsontable 렌더
    // =========================================================
    function renderGridForCurrentTarget(){
      const cur = ds(fileKey);
      const container = document.getElementById("hotContainer");
      container.innerHTML = "";

      const headers = cur.headers || [];
      const rows = cur.rows || [];
      const viewRows = rows.slice(-GRID_LIMIT);

      if (hot) { hot.destroy(); hot = null; }

      hot = new Handsontable(container, {
        data: viewRows,
        rowHeaders: true,
        colHeaders: headers,
        height: 560,
        width: "100%",
        stretchH: "all",
        licenseKey: "non-commercial-and-evaluation",
        readOnly: true,
        contextMenu: false,
        manualColumnResize: true,
        manualRowResize: true,
        filters: true,
        dropdownMenu: true,
        cells: function (row, col) {
          const props = {};
          const startGlobal = Math.max(0, rows.length - GRID_LIMIT);
          const globalIdx = startGlobal + row;
          if (cur.highlight.has(globalIdx)) {
            props.className = (props.className ? props.className + " " : "") + "hot-row-highlight";
          }
          return props;
        }
      });

      setTimeout(() => { hot.render(); hot.refreshDimensions(); }, 0);
    }

    function selectTarget(target, isInit=false) {
      fileKey = target;
      localStorage.setItem("gh_target", fileKey);

      document.getElementById("tabDeceased").classList.toggle("active", fileKey === "deceased");
      document.getElementById("tabNature").classList.toggle("active", fileKey === "nature");

      if (isLoaded) {
        const total = ds(fileKey).rows.length;
        document.getElementById("gridMeta").textContent =
          `${ds(fileKey).label} · 최근 ${GRID_LIMIT}건 표시 (총 ${total}건)`;
      } else {
        document.getElementById("gridMeta").textContent = `${ds(fileKey).label} · 최근 ${GRID_LIMIT}건 표시`;
      }

      if (isLoaded) renderGridForCurrentTarget();

      if (!isInit && isLoaded) {
        const loadedFilesText = `추모의집 ${ds("deceased").rows.length}건 / 자연장지 ${ds("nature").rows.length}건`;
        updateLoginInfoBox(true, loadedAtText, loadedFilesText, document.getElementById("branch").value.trim() || "main");
      }
    }

    // =========================================================
    //  로드(로그인)
    // =========================================================
    async function loadAllFiles() {
      const inputs = getInputs();
      const { owner, repo, token, branch } = inputs;

      hideLoginFail();

      if (!owner || !repo || !token) {
        const msg = "Owner / Repo / Token을 모두 입력해 주세요.";
        showLoginFail(msg);
        showStatus(msg, "error");
        setLoaded(false);
        openLoginModal(true);
        return;
      }

      saveInputsToStorage({owner, repo, token, branch});

      setBusy(true);
      showStatus("추모의집/자연장지(JSON) 데이터를 불러오는 중입니다...", "loading");

      try {
        DATASETS.deceased.loaded = false;
        DATASETS.nature.loaded = false;

        const tasks = [
          fetchJsonFromGitHub(inputs, DATASETS.deceased.path).then(res => ({ key:"deceased", ...res })),
          fetchJsonFromGitHub(inputs, DATASETS.nature.path).then(res => ({ key:"nature", ...res }))
        ];

        const results = await Promise.allSettled(tasks);

        const errors = [];
        for (const r of results){
          if (r.status === "rejected") errors.push(r.reason?.message || String(r.reason));
          else {
            const { key, sha, data } = r.value;
            ds(key).sha = sha;
            normalizeLoadedDatasetFromJson(key, data);
          }
        }

        if (errors.length){
          setLoaded(false);
          throw new Error("로드에 실패하였습니다:\n" + errors.join("\n\n"));
        }

        const now = new Date();
        loadedAtText = formatLoadedAt(now);
        localStorage.setItem("gh_loaded_at", loadedAtText);

        setLoaded(true);

        const loadedFilesText = `추모의집 ${ds("deceased").rows.length}건 / 자연장지 ${ds("nature").rows.length}건`;
        updateLoginInfoBox(true, loadedAtText, loadedFilesText, branch);

        showStatus("로드가 완료되었습니다.", "success");

        const total = ds(fileKey).rows.length;
        document.getElementById("gridMeta").textContent =
          `${ds(fileKey).label} · 최근 ${GRID_LIMIT}건 표시 (총 ${total}건)`;

        renderGridForCurrentTarget();

        closeLoginModal(); // ✅ 성공 시에만 닫기

      } catch (e) {
        setLoaded(false);
        const msg = e.message || String(e);
        showStatus(msg, "error");
        openLoginModal(true);
        showLoginFail(msg);
      } finally {
        setBusy(false);
      }
    }

    // =========================================================
    //  초기화
    // =========================================================
    function resetAllSettings(){
      ["gh_owner","gh_repo","gh_branch","gh_target","gh_loaded_at","gh_token_persist"].forEach(k=>localStorage.removeItem(k));
      localStorage.removeItem("gh_token");
      sessionStorage.removeItem("gh_token");

      ["owner","repo","token"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      const b = document.getElementById("branch");
      if (b) b.value = "main";

      const persistEl = document.getElementById("tokenPersist");
      if (persistEl) persistEl.checked = true;

      fileKey = "deceased";
      selectTarget(fileKey, true);
      setLoaded(false);

      updateLoginInfoBox(false, "", "", "main");
      resetBulkUpload();

      openLoginModal(true);
      showStatus("설정이 초기화되었습니다.", "success");
    }

    // =========================================================
    //  업로드 파일 선택/드롭
    // =========================================================
    function makeFileId(file){
      return `${file.name}__${file.size}__${file.lastModified}`;
    }
    function triggerFilePick(){
      if (!isLoaded || isBusy) return;
      document.getElementById("bulkFile")?.click();
    }
    function addSelectedFiles(files){
      const exist = new Set(selectedFiles.map(x => x.id));
      for (const f of files){
        const id = makeFileId(f);
        if (exist.has(id)) continue;
        selectedFiles.push({ id, file: f });
        exist.add(id);
      }
    }
    function removeSelectedFile(id){
      selectedFiles = selectedFiles.filter(x => x.id !== id);
      renderSelectedFiles();
      updateBulkButtonState();
    }
    function renderSelectedFiles(){
      const box = document.getElementById("selectedFiles");
      const cnt = document.getElementById("selectedFileCount");
      cnt.textContent = String(selectedFiles.length);

      if (!selectedFiles.length){
        box.innerHTML = `<span class="muted">선택된 파일 없음</span>`;
        return;
      }

      const items = selectedFiles.map(({id, file}) => {
        return `
          <li>
            <div class="file-left">
              <div class="file-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
              <div class="file-sub">
                <span class="mono">${escapeHtml(formatBytes(file.size))}</span>
                <span class="mono">${escapeHtml(new Date(file.lastModified).toLocaleString())}</span>
              </div>
            </div>
            <button class="x-btn" type="button" title="목록에서 제거" onclick="removeSelectedFile('${id}')">×</button>
          </li>
        `;
      }).join("");

      box.innerHTML = `<ul class="file-list">${items}</ul>`;
    }
    function updateBulkButtonState(){
      const btn = document.getElementById("bulkBtn");
      if (!btn) return;
      btn.disabled = (!isLoaded || isBusy || selectedFiles.length === 0);
    }
    function resetBulkUpload(){
      selectedFiles = [];
      renderSelectedFiles();
      updateBulkButtonState();
      if (isLoaded) showStatus("선택 파일 목록이 초기화되었습니다.", "success");
    }

    // =========================================================
    //  모달: 일괄등록 확인
    // =========================================================
    function openConfirmModal(){
      document.getElementById("confirmModalBackdrop").style.display = "flex";
    }
    function closeConfirmModal(){
      document.getElementById("confirmModalBackdrop").style.display = "none";
    }
    function confirmBulkOk(){
      closeConfirmModal();
      importBulkExcelAutoSave();
    }
    function confirmBulkCancel(){
      closeConfirmModal();
      showStatus("일괄등록이 취소되었습니다.", "success");
    }
    document.getElementById("confirmModalBackdrop")?.addEventListener("click", (e) => {
      if (e.target.id === "confirmModalBackdrop") confirmBulkCancel();
    });
    function confirmAndImportBulkExcelAutoSave(){
      if (!isLoaded) {
        showLoadHint(true);
        setLoaded(false);
        showStatus("먼저 ‘로그인(불러오기)’를 진행해 주세요.", "error");
        openLoginModal(true);
        return;
      }
      if (isBusy) return;

      if (!selectedFiles.length){
        showStatus("일괄등록할 파일을 추가해 주세요.", "error");
        return;
      }

      openConfirmModal();
    }

    // =========================================================
    //  실패 로그 모달
    // =========================================================
    function openLogModal(title){
      document.getElementById("logModalTitle").textContent = title;
      document.getElementById("logModalBackdrop").style.display = "flex";
      renderLogModalBody();
    }
    function closeLogModal(){
      document.getElementById("logModalBackdrop").style.display = "none";
    }
    document.getElementById("logModalBackdrop")?.addEventListener("click", (e) => {
      if (e.target.id === "logModalBackdrop") closeLogModal();
    });
    function parseRowNo(v){
      const n = parseInt(String(v ?? "").replace(/[^0-9]/g,""), 10);
      return Number.isFinite(n) ? n : 999999999;
    }
    function renderLogModalBody(){
      const body = document.getElementById("logModalBody");
      body.innerHTML = buildFailLogSectionsByFile();
    }
    function buildFailLogSectionsByFile(){
      if (!importFailLog.length){
        return `<div class="muted">실패 로그가 없습니다.</div>`;
      }

      const list = importFailLog.slice();
      const groups = new Map();
      for (const item of list){
        const key = String(item.file || "-");
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(item);
      }

      const fileNames = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b,"ko"));

      let html = "";
      for (const fn of fileNames){
        const arr = groups.get(fn);
        arr.sort((a,b)=>parseRowNo(a.rowNo) - parseRowNo(b.rowNo));

        html += `
          <div class="file-section">
            <div class="file-section-head">
              <div>${escapeHtml(fn)}</div>
              <div class="mini">${arr.length}건</div>
            </div>
            <table class="q">
              <thead>
                <tr>
                  <th style="width:80px;">행</th>
                  <th style="width:90px;">대상</th>
                  <th style="width:70px;">구분</th>
                  <th style="width:220px;">번호</th>
                  <th style="width:120px;">사망자명</th>
                  <th style="width:120px;">신청자명</th>
                  <th>사유</th>
                </tr>
              </thead>
              <tbody>
        `;

        for (const l of arr){
          html += `
            <tr>
              <td>${escapeHtml(l.rowNo)}</td>
              <td><b>${escapeHtml(l.target || "-")}</b></td>
              <td>${escapeHtml(l.kind || "-")}</td>
              <td><b>${escapeHtml(l.no || "")}</b></td>
              <td>${escapeHtml(l.deceased || "")}</td>
              <td>${escapeHtml(l.applicant || "")}</td>
              <td class="danger">${escapeHtmlWithBr(l.reason || "")}</td>
            </tr>
          `;
        }

        html += `
              </tbody>
            </table>
          </div>
        `;
      }

      return html;
    }

    // =========================================================
    //  대상 판별 / 템플릿 판별
    // =========================================================
    function detectTargetByNo(noRaw){
      const s = String(noRaw ?? "").trim();
      if (!s) return null;

      if (s.includes("추모의집")) return "deceased";
      if (s.includes("잔디장") || s.includes("수목장") || s.includes("자연장")) return "nature";

      if (/-\\d{1,3}실-/.test(s) || /\\b\\d{1,3}실\\b/.test(s) || /\\d{1,3}실/.test(s)) return "deceased";
      if (/^[^-]+-\\d+-\\d+-\\d{4}$/.test(s)) return "nature";

      const m = s.match(/(\\d+)\\s*$/);
      if (m){
        const len = m[1].length;
        if (len === 5) return "deceased";
        if (len === 4) return "nature";
      }
      return null;
    }

    function detectTemplateTypeByHeaders(rowsObj){
      const keys = new Set();
      for (const r of rowsObj || []){
        Object.keys(r || {}).forEach(k => keys.add(norm(k)));
        if (keys.size > 30) break;
      }
      const hasDe = ["봉안번호","봉안 번호","봉안no","봉안No"].some(x => keys.has(norm(x)));
      const hasNa = ["자연장번호","자연장 번호","자연장no","자연장No","안장번호","안장 번호"].some(x => keys.has(norm(x)));
      if (hasDe && !hasNa) return "deceased";
      if (hasNa && !hasDe) return "nature";
      if (hasDe && hasNa) return "mixed";
      return "unknown";
    }

    function isMeaningfulRow(rowObj){
      const noRaw = String(getCellByHeader(rowObj, ["봉안번호","봉안 번호","자연장번호","자연장 번호","안장번호","안장 번호","번호","관리번호"])).trim();
      const deceased = String(getCellByHeader(rowObj, ["사망자명","고인명","고인","사망자"])).trim();
      const applicant = String(getCellByHeader(rowObj, ["신청자명","신청자","사용자명","계약자명"])).trim();
      const inDateRaw = String(getCellByHeader(rowObj, ["안치일자","안치 일자","안치일"])).trim();
      const returnRaw = String(getCellByHeader(rowObj, ["반환일자","반환 일자","반환일"])).trim();
      return !!(noRaw || deceased || applicant || inDateRaw || returnRaw);
    }

    function shouldSkipStructuralRow(templateType, idx, lastIdx, rowObj){
      if (templateType === "nature") {
        const noRaw = String(getCellByHeader(rowObj, ["자연장번호","자연장 번호","안장번호","안장 번호","번호","관리번호","봉안번호","봉안 번호"])).trim();
        const deceased = String(getCellByHeader(rowObj, ["사망자명","고인명","고인","사망자"])).trim();
        const applicant = String(getCellByHeader(rowObj, ["신청자명","신청자","사용자명","계약자명"])).trim();

        if (!noRaw && norm(deceased) === norm("이름") && norm(applicant) === norm("이름")) {
          return true;
        }
      }

      const meaningful = isMeaningfulRow(rowObj);

      if (!meaningful){
        if (templateType === "nature"){
          if (idx === 0) return true;
          if (idx === lastIdx) return true;
        } else if (templateType === "deceased"){
          if (idx === lastIdx) return true;
        } else {
          if (idx === 0 || idx === lastIdx) return true;
        }
      }
      if (!meaningful) return true;
      return false;
    }

    function findExactMatchRowDeceased(noVal, deceasedVal, applicantVal, rowsOverride=null, headersOverride=null) {
      const d = ds("deceased");
      const rows = rowsOverride || d.rows;
      const headers = headersOverride || d.headers;

      const idxNo = findHeaderIndex(headers, ["봉안번호","봉안 번호","봉안no","봉안No","번호","관리번호"]);
      const idxDe = findHeaderIndex(headers, ["사망자명","고인명","고인","사망자"]);
      const idxAp = findHeaderIndex(headers, ["신청자명","신청자","사용자명","계약자명"]);
      const idxReturn = findHeaderIndex(headers, ["반환일자","반환 일자","반환일"]);

      const missing = [];
      if (idxNo === -1) missing.push("봉안번호");
      if (idxDe === -1) missing.push("사망자명");
      if (idxAp === -1) missing.push("신청자명");
      if (idxReturn === -1) missing.push("반환일자");
      if (missing.length) throw new Error("헤더를 찾을 수 없습니다: " + missing.join(", "));

      const noN = norm(noVal), deN = norm(deceasedVal), apN = norm(applicantVal);

      for (let r = 0; r < rows.length; r++) {
        const row = rows[r];
        if (norm(row[idxNo]) === noN && norm(row[idxDe]) === deN && norm(row[idxAp]) === apN) {
          const hasReturn = String(row[idxReturn] ?? "").trim() !== "";
          return { found:true, rowIndex:r, idxReturn, hasReturn };
        }
      }
      return { found:false };
    }

    // =========================================================
    //  일괄등록: 엑셀 업로드 → 분석/검증 → JSON 저장(즉시)
    // =========================================================
    async function importBulkExcelAutoSave() {
      if (!isLoaded) {
        showLoadHint(true);
        setLoaded(false);
        showStatus("먼저 ‘로그인(불러오기)’를 진행해 주세요.", "error");
        openLoginModal(true);
        return;
      }
      if (isBusy) return;

      if (!selectedFiles.length){
        showStatus("일괄등록할 파일을 추가해 주세요.", "error");
        return;
      }

      setBusy(true);
      showStatus("일괄등록 준비(분석) → 자동 분류 → JSON 저장 중입니다...", "loading");

      try {
        importFailLog = [];
        const adds = { deceased: [], nature: [] };
        const rets = [];

        // ✅ 업로드 내 동일 번호 허용(부부=2명) 반영
        const uploadNoCount = { deceased: new Map(), nature: new Map() };
        const uploadNoMax   = { deceased: new Map(), nature: new Map() };

        const uploadRetKeySet = new Set();
        let processed = 0;

        for (const item of selectedFiles){
          const file = item.file;

          const lower = (file.name || "").toLowerCase();
          if (!(lower.endsWith(".xlsx") || lower.endsWith(".xls"))){
            importFailLog.push({ file:file.name, rowNo:"-", target:"-", kind:"-", no:"", deceased:"", applicant:"", reason:"확장자가 .xlsx/.xls가 아닙니다." });
            continue;
          }

          let wb;
          try {
            const buf = await file.arrayBuffer();
            wb = XLSX.read(new Uint8Array(buf), { type: "array" });
          } catch (e) {
            importFailLog.push({ file:file.name, rowNo:"-", target:"-", kind:"-", no:"", deceased:"", applicant:"", reason:"파일 읽기에 실패하였습니다(손상 가능)." });
            continue;
          }

          if (!wb || !wb.SheetNames || wb.SheetNames.length === 0){
            importFailLog.push({ file:file.name, rowNo:"-", target:"-", kind:"-", no:"", deceased:"", applicant:"", reason:"시트가 없습니다." });
            continue;
          }

          const ws = wb.Sheets[wb.SheetNames[0]];
          if (!ws){
            importFailLog.push({ file:file.name, rowNo:"-", target:"-", kind:"-", no:"", deceased:"", applicant:"", reason:"첫 시트 접근에 실패하였습니다." });
            continue;
          }

          const rowsObj = XLSX.utils.sheet_to_json(ws, { defval: "" });

          if (!rowsObj || rowsObj.length === 0){
            importFailLog.push({ file:file.name, rowNo:"-", target:"-", kind:"-", no:"", deceased:"", applicant:"", reason:"데이터가 없습니다(빈 시트)." });
            continue;
          }

          const templateType = detectTemplateTypeByHeaders(rowsObj);
          const lastIndex = rowsObj.length - 1;

          for (let i = 0; i < rowsObj.length; i++) {
            const r = rowsObj[i];
            const rowNo = i + 2;

            if (shouldSkipStructuralRow(templateType, i, lastIndex, r)) continue;
            processed++;

            const noRaw = String(getCellByHeader(r, ["봉안번호","봉안 번호","자연장번호","자연장 번호","안장번호","안장 번호","번호","관리번호"])).trim();
            const deceased = String(getCellByHeader(r, ["사망자명","고인명","고인","사망자"])).trim();
            const applicant = String(getCellByHeader(r, ["신청자명","신청자","사용자명","계약자명"])).trim();
            const inDateRaw = String(getCellByHeader(r, ["안치일자","안치 일자","안치일"])).trim();
            const returnRaw = String(getCellByHeader(r, ["반환일자","반환 일자","반환일"])).trim();

            if (!noRaw){
              importFailLog.push({ file:file.name, rowNo, target:"-", kind:"-", no:noRaw, deceased, applicant, reason:"번호(봉안/자연장)가 누락되었습니다." });
              continue;
            }

            const targetKey = detectTargetByNo(noRaw);
            if (!targetKey){
              importFailLog.push({
                file:file.name,
                rowNo,
                target:"판별실패",
                kind:"-",
                no:noRaw,
                deceased,
                applicant,
                reason: "번호 패턴으로 대상(추모의집/자연장지) 판별에 실패하였습니다.\n" + DETECT_HINT
              });
              continue;
            }
            const targetLabel = ds(targetKey).label;

            const isReturn = !!String(returnRaw).trim();
            const kind = isReturn ? "반환" : "신규";

            if (isReturn){
              if (targetKey !== "deceased"){
                importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"자연장지는 반환 처리가 불가합니다." });
                continue;
              }
              if (!deceased || !applicant){
                importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"필수값 누락(사망자명/신청자명)으로 반환 처리 불가합니다." });
                continue;
              }
              const returnDate = normalizeDate(returnRaw);
              if (!returnDate){
                importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"반환일자 형식이 올바르지 않습니다." });
                continue;
              }

              const key3 = norm(noRaw) + "|" + norm(deceased) + "|" + norm(applicant);
              if (uploadRetKeySet.has(key3)){
                importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"업로드 파일(전체) 내 반환 항목이 중복되었습니다(번호/사망자/신청자)." });
                continue;
              }
              uploadRetKeySet.add(key3);

              rets.push({ file:file.name, rowNo, no:noRaw, deceased, applicant, returnDate });
              continue;
            }

            // 신규
            if (!deceased || !applicant){
              importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"필수값이 누락되었습니다(사망자명/신청자명)." });
              continue;
            }
            if (!inDateRaw){
              importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"안치일자가 누락되었습니다(신규)." });
              continue;
            }
            const inDate = normalizeDate(inDateRaw);
            if (!inDate){
              importFailLog.push({ file:file.name, rowNo, target:targetLabel, kind, no:noRaw, deceased, applicant, reason:"안치일자 형식이 올바르지 않습니다(신규)." });
              continue;
            }

            // ✅ 같은 행에 '부부' 포함이면 동일 번호 2명까지 허용
            const isCouple = coupleFlagFromRow(r);
            const vNo = norm(noRaw);

            const prevMax = uploadNoMax[targetKey].get(vNo) ?? 1;
            const maxAllowed = isCouple ? Math.max(prevMax, 2) : prevMax;
            uploadNoMax[targetKey].set(vNo, maxAllowed);

            const curCnt = uploadNoCount[targetKey].get(vNo) ?? 0;
            if (curCnt + 1 > maxAllowed){
              importFailLog.push({
                file:file.name, rowNo, target:targetLabel, kind:"신규",
                no:noRaw, deceased, applicant,
                reason: (maxAllowed === 2)
                  ? "업로드 파일(전체) 내 동일 번호가 2건을 초과했습니다(부부 허용 2건)."
                  : "업로드 파일(전체) 내 동일 번호가 중복되었습니다."
              });
              continue;
            }
            uploadNoCount[targetKey].set(vNo, curCnt + 1);

            adds[targetKey].push({ file:file.name, rowNo, inDate, no:noRaw, deceased, applicant });
          }
        }

        if (processed === 0){
          showStatus("일괄등록할 데이터가 없습니다(예외/빈 행만 존재).", "error");
          const html =
            `<div style="font-weight:900; font-size:14px; margin-bottom:10px;">일괄등록 결과</div>` +
            `<div style="line-height:1.7;">성공 <b>0</b>건<br>실패 <b>${importFailLog.length}</b>건</div>`;
          openResultModal(html, importFailLog.length > 0);
          return;
        }

        // next (메모리 복사)
        const next = {
          deceased: { headers: ds("deceased").headers.slice(), rows: ds("deceased").rows.map(r=>r.slice()), highlight: new Set() },
          nature:   { headers: ds("nature").headers.slice(),   rows: ds("nature").rows.map(r=>r.slice()),   highlight: new Set() }
        };

        const applyAdds = (key) => {
          if (!adds[key].length) return 0;

          const headers = next[key].headers;
          const rows = next[key].rows;

          const idxInDate = findHeaderIndex(headers, ["안치일자","안치 일자","안치일"]);
          const idxNo = findHeaderIndex(headers, noHeaderCandidatesFor(key));
          const idxDe = findHeaderIndex(headers, ["사망자명","고인명","고인","사망자"]);
          const idxAp = findHeaderIndex(headers, ["신청자명","신청자","사용자명","계약자명"]);

          const missing = [];
          if (idxInDate === -1) missing.push("안치일자");
          if (idxNo === -1) missing.push(key === "deceased" ? "봉안번호" : "자연장번호/안장번호");
          if (idxDe === -1) missing.push("사망자명");
          if (idxAp === -1) missing.push("신청자명");

          const idxReturn = (key === "deceased")
            ? findHeaderIndex(headers, ["반환일자","반환 일자","반환일"])
            : -1;
          if (key === "deceased" && idxReturn === -1) missing.push("반환일자");

          if (missing.length) throw new Error(`[${ds(key).label}] 헤더를 찾을 수 없습니다: ${missing.join(", ")}`);

          // ✅ 번호별 "현재 사용중" 인원 수 집계
          const activeCount = new Map();

          if (key === "deceased") {
            for (const row of rows) {
              const vv = norm(row[idxNo]);
              if (!vv) continue;

              const hasRet = String(row[idxReturn] ?? "").trim() !== "";
              if (hasRet) continue;

              activeCount.set(vv, (activeCount.get(vv) ?? 0) + 1);
            }
          } else {
            for (const row of rows) {
              const vv = norm(row[idxNo]);
              if (!vv) continue;
              activeCount.set(vv, (activeCount.get(vv) ?? 0) + 1);
            }
          }

          let added = 0;

          for (const q of adds[key]){
            const vv = norm(q.no);

            // ✅ 업로드 기준 maxAllowed(부부=2, 아니면 1)
            const maxAllowed = (uploadNoMax[key].get(vv) ?? 1);
            const curActive = activeCount.get(vv) ?? 0;

            if (curActive + 1 > maxAllowed){
              importFailLog.push({
                file:q.file, rowNo:q.rowNo,
                target:ds(key).label, kind:"신규",
                no:q.no, deceased:q.deceased, applicant:q.applicant,
                reason: (maxAllowed === 2)
                  ? "해당 번호는 현재 사용중 2건까지 허용되며(부부), 이미 2건이 사용 중입니다."
                  : "해당 대상 파일의 기존 번호와 중복됩니다(1건만 허용)."
              });
              continue;
            }

            const row = new Array(headers.length).fill("");
            row[idxInDate] = q.inDate;
            row[idxNo] = q.no;
            row[idxDe] = q.deceased;
            row[idxAp] = q.applicant;

            rows.push(row);
            next[key].highlight.add(rows.length - 1);
            added++;

            activeCount.set(vv, curActive + 1);
          }

          return added;
        };

        const applyReturns = () => {
          if (!rets.length) return 0;

          const headers = next.deceased.headers;
          const rows = next.deceased.rows;
          let applied = 0;

          const keySet = new Set();
          for (const q of rets){
            const k = norm(q.no) + "|" + norm(q.deceased) + "|" + norm(q.applicant);
            if (keySet.has(k)){
              importFailLog.push({ file:q.file, rowNo:q.rowNo, target:"추모의집", kind:"반환", no:q.no, deceased:q.deceased, applicant:q.applicant, reason:"업로드 내 반환 항목이 중복되었습니다(번호/사망자/신청자)." });
              continue;
            }
            keySet.add(k);

            let match;
            try {
              match = findExactMatchRowDeceased(q.no, q.deceased, q.applicant, rows, headers);
            } catch (e) {
              importFailLog.push({ file:q.file, rowNo:q.rowNo, target:"추모의집", kind:"반환", no:q.no, deceased:q.deceased, applicant:q.applicant, reason:e.message || "헤더 확인이 필요합니다." });
              continue;
            }

            if (!match.found){
              importFailLog.push({ file:q.file, rowNo:q.rowNo, target:"추모의집", kind:"반환", no:q.no, deceased:q.deceased, applicant:q.applicant, reason:"기존 정보와 일치하는 행을 찾을 수 없습니다(완전일치 필요)." });
              continue;
            }
            if (match.hasReturn){
              importFailLog.push({ file:q.file, rowNo:q.rowNo, target:"추모의집", kind:"반환", no:q.no, deceased:q.deceased, applicant:q.applicant, reason:"이미 반환일자가 등록되어 있습니다." });
              continue;
            }

            rows[match.rowIndex][match.idxReturn] = q.returnDate;
            next.deceased.highlight.add(match.rowIndex);
            applied++;
          }

          return applied;
        };

        const addedDe = applyAdds("deceased");
        const addedNa = applyAdds("nature");
        const retDe = applyReturns();

        const needSaveDe = (addedDe > 0) || (retDe > 0);
        const needSaveNa = (addedNa > 0);

        // 저장할 게 없다면: 결과 모달만 띄우기
        if (!needSaveDe && !needSaveNa){
          showStatus("저장할 항목이 없습니다. (모두 실패/중복/판별실패)", "error");

          const failCount = importFailLog.length;
          const successCount = 0;

          const html =
            `<div style="font-weight:900; font-size:14px; margin-bottom:10px;">일괄등록 결과</div>` +
            `<div style="line-height:1.7;">` +
              `<div>성공 <b>${successCount}</b>건</div>` +
              `<div>실패 <b>${failCount}</b>건</div>` +
            `</div>`;

          openResultModal(html, failCount > 0);
          return;
        }

        // ✅ JSON 저장
        const saveErrors = [];

        try {
          if (needSaveDe){
            await putJsonToGitHub("deceased", {
              format: "ulsan_skypark_dataset_v1",
              headers: next.deceased.headers,
              rows: next.deceased.rows
            }, `Auto bulk save (deceased) new:${addedDe} return:${retDe} ${new Date().toISOString()}`);
          }
        } catch (e) {
          saveErrors.push(e.message || String(e));
        }

        try {
          if (needSaveNa){
            await putJsonToGitHub("nature", {
              format: "ulsan_skypark_dataset_v1",
              headers: next.nature.headers,
              rows: next.nature.rows
            }, `Auto bulk save (nature) new:${addedNa} ${new Date().toISOString()}`);
          }
        } catch (e) {
          saveErrors.push(e.message || String(e));
        }

        if (saveErrors.length){
          showStatus("저장 중 오류가 발생하였습니다.\n" + saveErrors.join("\n\n"), "error");
          return;
        }

        // 메모리 반영 + 하이라이트
        if (needSaveDe){
          ds("deceased").rows = next.deceased.rows;
          ds("deceased").headers = next.deceased.headers;
          ds("deceased").highlight = next.deceased.highlight;
        }
        if (needSaveNa){
          ds("nature").rows = next.nature.rows;
          ds("nature").headers = next.nature.headers;
          ds("nature").highlight = next.nature.highlight;
        }

        renderGridForCurrentTarget();

        const inputs = getInputs();
        const loadedFilesText = `추모의집 ${ds("deceased").rows.length}건 / 자연장지 ${ds("nature").rows.length}건`;
        updateLoginInfoBox(true, loadedAtText, loadedFilesText, inputs.branch);

        const total = ds(fileKey).rows.length;
        document.getElementById("gridMeta").textContent =
          `${ds(fileKey).label} · 최근 ${GRID_LIMIT}건 표시 (총 ${total}건)`;

        const msg =
          `일괄등록이 완료되었습니다.\n` +
          `추모의집: 신규 ${addedDe} / 반환 ${retDe}\n` +
          `자연장지: 신규 ${addedNa}\n` +
          (importFailLog.length ? `실패 ${importFailLog.length}건(결과 모달에서 확인 가능)` : `실패 0건`);
        showStatus(msg, "success");

        // ✅ 결과 모달
        const failCount = importFailLog.length;
        const successCount = (addedDe + retDe + addedNa);

        const html =
          `<div style="font-weight:900; font-size:14px; margin-bottom:10px;">일괄등록 결과</div>` +
          `<div style="line-height:1.7; margin-bottom:10px;">` +
            `<div>성공 <b>${successCount}</b>건</div>` +
            `<div>실패 <b>${failCount}</b>건</div>` +
          `</div>` +
          `<div style="font-size:13px; color:#374151; font-weight:800; line-height:1.6;">` +
            `추모의집: 신규 ${addedDe} / 반환 ${retDe}<br>` +
            `자연장지: 신규 ${addedNa}` +
          `</div>`;

        openResultModal(html, failCount > 0);

      } catch (e) {
        showStatus(e.message || String(e), "error");
      } finally {
        setBusy(false);
      }
    }

    // =========================================================
    //  부트스트랩
    // =========================================================
    window.onload = () => {
      const savedOwner  = localStorage.getItem("gh_owner");
      const savedRepo   = localStorage.getItem("gh_repo");
      const savedBranch = localStorage.getItem("gh_branch");
      const savedTarget = localStorage.getItem("gh_target");
      const savedLoadedAt = localStorage.getItem("gh_loaded_at");

      const savedPersist = localStorage.getItem("gh_token_persist");
      const persist = (savedPersist === null) ? true : (savedPersist === "1");
      const persistEl = document.getElementById("tokenPersist");
      if (persistEl) persistEl.checked = persist;

      if (savedOwner) document.getElementById("owner").value = savedOwner;
      if (savedRepo)  document.getElementById("repo").value  = savedRepo;
      document.getElementById("branch").value = savedBranch || "main";
      if (savedTarget === "nature") fileKey = "nature";

      const savedToken = (persist ? localStorage : sessionStorage).getItem("gh_token");
      if (savedToken) document.getElementById("token").value = savedToken;

      selectTarget(fileKey, true);
      setLoaded(false);
      updateLoginInfoBox(false, savedLoadedAt || "", "", document.getElementById("branch").value.trim() || "main");
      showLoadHint(true);

      // Enter키 = 로그인(불러오기)
      ["owner","repo","token","branch"].forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener("keydown", (e)=>{
          if(e.key === "Enter") loadAllFiles();
        });
      });

      // 토큰 저장 옵션 변경 시 즉시 반영
      document.getElementById("tokenPersist")?.addEventListener("change", (e)=>{
        const persistNow = e.target.checked;
        localStorage.setItem("gh_token_persist", persistNow ? "1" : "0");

        const tokenVal = document.getElementById("token")?.value?.trim() || "";
        if (persistNow){
          if (tokenVal) localStorage.setItem("gh_token", tokenVal);
          sessionStorage.removeItem("gh_token");
        } else {
          if (tokenVal) sessionStorage.setItem("gh_token", tokenVal);
          localStorage.removeItem("gh_token");
        }
      });

      // 토큰 입력 변경 시 저장값 최신화
      document.getElementById("token")?.addEventListener("input", ()=>{
        const v = document.getElementById("token")?.value?.trim() || "";
        if (!v) return;
        if (isTokenPersistEnabled()){
          localStorage.setItem("gh_token", v);
          sessionStorage.removeItem("gh_token");
        } else {
          sessionStorage.setItem("gh_token", v);
          localStorage.removeItem("gh_token");
        }
      });

      // 파일 선택
      document.getElementById("bulkFile")?.addEventListener("change", (e) => {
        const input = e.target;
        const files = Array.from(input.files || []);
        if (!files.length) return;

        addSelectedFiles(files);
        input.value = "";

        renderSelectedFiles();
        updateBulkButtonState();
      });

      // 드래그 앤 드롭
      const dz = document.getElementById("fileDropZone");
      if (dz){
        const stop = (e)=>{ e.preventDefault(); e.stopPropagation(); };
        ["dragenter","dragover"].forEach(evt=>{
          dz.addEventListener(evt, (e)=>{
            stop(e);
            if (!isLoaded || isBusy) return;
            dz.classList.add("drop-ready");
          });
        });
        ["dragleave","drop"].forEach(evt=>{
          dz.addEventListener(evt, (e)=>{
            stop(e);
            dz.classList.remove("drop-ready");
          });
        });
        dz.addEventListener("drop", (e)=>{
          if (!isLoaded || isBusy) return;
          const files = Array.from(e.dataTransfer?.files || []).filter(f=>{
            const lower = (f.name || "").toLowerCase();
            return lower.endsWith(".xlsx") || lower.endsWith(".xls");
          });
          if (!files.length) return;
          addSelectedFiles(files);
          renderSelectedFiles();
          updateBulkButtonState();
        });
      }

      renderSelectedFiles();
      updateBulkButtonState();

      // ✅ 최초 진입: 로드 전이면 로그인 모달 오픈
      openLoginModal(false);
    };
  </script>
</body>
</html>