<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>울산하늘공원 데이터 관리자 (웹 편집)</title>

  <!-- Handsontable (엑셀 편집 UI) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <!-- XLSX (엑셀 처리) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f6f2ec;
      color: #2f2a25;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 1200px;
    }
    h1 { margin-top: 0; font-size: 22px; color: #3a332e; text-align: center; margin-bottom: 20px; }

    .config-box {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .form-group label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 4px; color: #555; }
    .form-group input { width: 100%; padding: 8px; border: 1px solid #dcdcdc; border-radius: 6px; font-size: 14px; box-sizing: border-box; }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-load { background-color: #3a332e; color: #fff; }
    .btn-load:hover { background-color: #524a42; }
    .btn-save { background-color: #27ae60; color: #fff; }
    .btn-save:hover { background-color: #219150; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }

    #hotContainer {
      width: 100%;
      height: 600px;
      overflow: hidden;
      border: 1px solid #dcdcdc;
      border-radius: 4px;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      display: none;
    }
    .status.success { background: #e0f5f0; color: #1d7c6b; }
    .status.error { background: #fdeaea; color: #b92b27; }
    .status.loading { background: #f0f0f0; color: #555; }
  </style>
</head>
<body>

  <div class="container">
    <h1>봉안 데이터 관리자 (웹 편집)</h1>

    <div class="config-box">
      <div class="form-group">
        <label>GitHub ID</label>
        <input type="text" id="owner" placeholder="예: hong-gildong" />
      </div>
      <div class="form-group">
        <label>저장소 이름</label>
        <input type="text" id="repo" placeholder="예: memorial-data" />
      </div>
      <div class="form-group">
        <label>파일 경로</label>
        <input type="text" id="path" value="data/deceased_data.xlsx" />
      </div>
      <div class="form-group">
        <label>Access Token</label>
        <input type="password" id="token" placeholder="ghp_..." />
      </div>
    </div>

    <div class="toolbar">
      <button id="loadBtn" class="btn btn-load" onclick="loadFile()">엑셀 불러오기</button>
      <button id="saveBtn" class="btn btn-save" onclick="saveFile()" disabled>변경사항 저장하기</button>
    </div>

    <div id="statusMsg" class="status"></div>
    <div id="hotContainer"></div>
  </div>

  <script>
    let hot;               // Handsontable 인스턴스
    let currentSha = "";   // 파일 덮어쓰기용 SHA 값
    let isDirty = false;   // 변경 여부

    window.onload = () => {
      ['gh_owner', 'gh_repo', 'gh_path', 'gh_token'].forEach(key => {
        const val = localStorage.getItem(key);
        if (val) document.getElementById(key.replace('gh_', '')).value = val;
      });
    };

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = 'status ' + type;
      el.style.display = 'block';

      if (type === 'success') {
        setTimeout(() => { el.style.display = 'none'; }, 3000);
      }
    }

    function setSaveEnabled(enabled) {
      document.getElementById('saveBtn').disabled = !enabled;
    }

    // base64(content) -> Uint8Array (줄바꿈 제거 포함)
    function base64ToUint8Array(base64) {
      const clean = base64.replace(/\s/g, ''); // GitHub content는 줄바꿈이 섞일 수 있음
      const binaryString = atob(clean);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      return bytes;
    }

    // Uint8Array -> base64 (대용량도 안전하게 chunk 처리)
    function uint8ArrayToBase64(u8) {
      let binary = '';
      const chunkSize = 0x8000; // 32KB
      for (let i = 0; i < u8.length; i += chunkSize) {
        const chunk = u8.subarray(i, i + chunkSize);
        binary += String.fromCharCode.apply(null, chunk);
      }
      return btoa(binary);
    }

    // 1) GitHub에서 엑셀 파일 다운로드 및 파싱
    async function loadFile() {
      const owner = document.getElementById('owner').value.trim();
      const repo  = document.getElementById('repo').value.trim();
      const path  = document.getElementById('path').value.trim();
      const token = document.getElementById('token').value.trim();

      if (!owner || !repo || !path || !token) {
        showStatus('모든 설정값을 입력해주세요.', 'error');
        return;
      }

      localStorage.setItem('gh_owner', owner);
      localStorage.setItem('gh_repo', repo);
      localStorage.setItem('gh_path', path);
      localStorage.setItem('gh_token', token);

      showStatus('GitHub에서 파일 불러오는 중...', 'loading');
      document.getElementById('loadBtn').disabled = true;
      setSaveEnabled(false);
      isDirty = false;

      try {
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
        const res = await fetch(apiUrl, {
          headers: {
            "Authorization": `Bearer ${token}`, // token 방식보다 Bearer가 더 안전/호환
            "Accept": "application/vnd.github+json"
          }
        });

        if (!res.ok) {
          const errTxt = await res.text();
          throw new Error(`파일을 찾을 수 없거나 권한이 없습니다. (${res.status}) ${errTxt}`);
        }

        const data = await res.json();
        if (!data.content) throw new Error("GitHub 응답에 파일 content가 없습니다(폴더를 지정했거나 파일이 아님).");

        currentSha = data.sha;

        // base64 -> bytes
        const bytes = base64ToUint8Array(data.content);

        // 엑셀 파싱
        const wb = XLSX.read(bytes, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        initGrid(aoa);

        showStatus('파일 로드 완료! 데이터를 수정하세요.', 'success');
        // 변경이 실제로 생길 때만 저장 버튼 활성화되게 할 거라 여기서는 OFF 유지
        setSaveEnabled(false);

      } catch (err) {
        showStatus('불러오기 실패: ' + err.message, 'error');
      } finally {
        document.getElementById('loadBtn').disabled = false;
      }
    }

    // 2) 그리드 초기화 (1행을 헤더로 사용 + 헤더 고정)
    function initGrid(aoa) {
      const container = document.getElementById('hotContainer');
      container.innerHTML = '';

      const headers = (aoa && aoa.length > 0) ? aoa[0] : [];
      const bodyData = (aoa && aoa.length > 1) ? aoa.slice(1) : [];

      hot = new Handsontable(container, {
        data: bodyData,
        rowHeaders: true,
        colHeaders: headers,
        fixedRowsTop: 0,
        height: '100%',
        width: '100%',
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: true,
        manualColumnResize: true,
        manualRowResize: true,
        filters: true,
        dropdownMenu: true,
        stretchH: 'all',
        afterChange: (changes, source) => {
          if (!changes) return;
          if (source === 'loadData') return;
          isDirty = true;
          setSaveEnabled(true);
        }
      });

      // 헤더(첫 줄)는 편집 대상이 아니므로 Grid 위에 고정하고 싶다면:
      //  - 지금은 colHeaders로 빼서 헤더 편집을 막는 형태
    }

    // 3) 수정된 데이터 GitHub에 저장
    async function saveFile() {
      if (!hot) return;

      const owner = document.getElementById('owner').value.trim();
      const repo  = document.getElementById('repo').value.trim();
      const path  = document.getElementById('path').value.trim();
      const token = document.getElementById('token').value.trim();

      if (!owner || !repo || !path || !token) {
        showStatus('설정값이 누락되었습니다.', 'error');
        return;
      }

      if (!isDirty) {
        showStatus('변경된 내용이 없습니다.', 'success');
        return;
      }

      if (!confirm("정말 수정사항을 GitHub에 저장하시겠습니까?")) return;

      showStatus('GitHub에 저장 중...', 'loading');
      setSaveEnabled(false);

      try {
        // 저장 시에는 헤더+데이터를 다시 합쳐서 엑셀로 만듦
        const headers = hot.getColHeader();
        const body = hot.getData();
        const merged = [headers, ...body];

        const newWs = XLSX.utils.aoa_to_sheet(merged);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, newWs, "Sheet1");

        const wbOut = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
        const bytes = new Uint8Array(wbOut);
        const contentBase64 = uint8ArrayToBase64(bytes);

        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`;
        const putBody = {
          message: `Update data via Admin Page: ${new Date().toISOString()}`,
          content: contentBase64,
          sha: currentSha
        };

        const res = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(putBody)
        });

        if (!res.ok) {
          const errTxt = await res.text();
          throw new Error(`저장 실패 (${res.status}): ${errTxt}`);
        }

        const resData = await res.json();
        currentSha = resData.content.sha;

        isDirty = false;
        showStatus('성공적으로 저장되었습니다! (반영까지 1~2분 소요)', 'success');

      } catch (err) {
        showStatus('저장 실패: ' + err.message, 'error');
        // 실패했으면 저장 버튼 다시 켜주기
        setSaveEnabled(true);
      }
    }
  </script>
</body>
</html>
