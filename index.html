<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>울산하늘공원 고인 검색</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "맑은 고딕", Arial, sans-serif;
      min-height: 100vh;
      text-align: center;

      /* 배경 유지 + 가독성용 오버레이 */
      background-image:
        linear-gradient(rgba(245,247,250,0.88), rgba(245,247,250,0.88)),
        url('https://user-gen-media-assets.s3.amazonaws.com/gemini_images/ddc34a29-edb7-477f-afa3-d0fc7c1dfd68.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;

      display: flex;
      justify-content: center;
      align-items: center;
      padding: 22px;
    }

    /* ===== 키오스크 카드 ===== */
    main{
      width: min(1080px, 100%);
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(31,58,90,0.10);
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(15, 23, 42, 0.12);
      overflow: hidden;
    }

    .header{
      padding: 26px 26px 14px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(250,252,255,1));
    }

    .title{
      font-size: 38px;
      font-weight: 900;
      color: #12335a;
      letter-spacing: -1px;
      line-height: 1.15;
    }

    .subnote{
      margin-top: 10px;
      font-size: 15px;
      color: rgba(18, 51, 90, 0.75);
      font-weight: 700;
    }

    /* ===== 탭(키오스크 스타일) ===== */
    .tabs{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      padding: 0 26px;
      margin-top: 16px;
    }

    .tab-btn{
      appearance: none;
      border: none;
      background: rgba(241, 245, 249, 1);
      color: #334155;
      cursor: pointer;
      padding: 16px 10px;
      font-size: 18px;
      font-weight: 900;
      position: relative;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.10);
      border-bottom: none;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .tab-btn + .tab-btn{
      border-left: none;
    }

    .tab-btn:hover{
      background: rgba(226, 232, 240, 1);
    }

    /* 선택 탭: 하단 파란 밑줄 + 흰 바탕 */
    .tab-btn.active{
      background: #ffffff;
      color: #0d47a1;
      z-index: 2;
    }
    .tab-btn.active::after{
      content:"";
      position:absolute;
      left: 18%;
      right: 18%;
      bottom: 8px;
      height: 5px;
      border-radius: 999px;
      background: #1976D2;
    }

    /* ===== 본문 ===== */
    .content{
      padding: 18px 26px 26px;
      background: #ffffff;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
    }

    /* 키오스크 입력영역 */
    .search-box{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      margin-top: 2px;
    }

    .input-wrap{
      position: relative;
      width: 100%;
    }

    .input-label{
      text-align: left;
      font-weight: 900;
      color: #1f3a5a;
      font-size: 16px;
      margin: 10px 0 8px;
    }

    input[type="text"]{
      width: 100%;
      height: 64px;
      padding: 0 18px;
      font-size: 20px;
      font-weight: 800;
      border-radius: 14px;
      border: 2px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      outline: none;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input[type="text"]:focus{
      border-color: rgba(25, 118, 210, 0.55);
      box-shadow: 0 10px 26px rgba(25,118,210,0.18);
    }

    .btn-search{
      height: 64px;
      padding: 0 26px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-size: 20px;
      font-weight: 900;
      color: #ffffff;
      background: linear-gradient(180deg, #1e88e5, #1565c0);
      box-shadow: 0 10px 26px rgba(21, 101, 192, 0.28);
      transition: transform 0.08s ease, box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .btn-search:active{
      transform: translateY(1px);
      box-shadow: 0 6px 18px rgba(21, 101, 192, 0.22);
    }

    /* 안내 문구(필요시) */
    .hint{
      margin-top: 12px;
      text-align: left;
      font-size: 14px;
      color: rgba(51, 65, 85, 0.85);
      font-weight: 700;
    }

    /* 결과 영역 */
    #result{
      display: none;
      margin-top: 16px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.10);
      background: #ffffff;
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.10);
      overflow: hidden;
      text-align: left;
    }

    .result-head{
      padding: 14px 16px;
      background: rgba(241, 245, 249, 1);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .result-title{
      font-size: 16px;
      font-weight: 900;
      color: #0f172a;
    }

    .result-sub{
      font-size: 13px;
      font-weight: 800;
      color: rgba(51, 65, 85, 0.85);
      text-align: right;
      white-space: nowrap;
    }

    .table-wrapper{
      max-height: 520px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td{
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      padding: 14px 14px;
      font-size: 18px;
      font-weight: 800;
      text-align: center;
      white-space: nowrap;
    }

    th{
      position: sticky;
      top: 0;
      background: #ffffff;
      z-index: 5;
      font-weight: 900;
      color: #1f3a5a;
      border-bottom: 2px solid rgba(25,118,210,0.25);
    }

    td{
      color: #0f172a;
    }

    tbody tr{
      cursor: pointer;
      transition: background 0.12s ease;
    }

    tbody tr:hover{
      background: rgba(227, 242, 253, 0.65);
    }

    .col-loc{
      font-family: "Malgun Gothic", "맑은 고딕", monospace;
      letter-spacing: 0px;
    }

    .loading{
      padding: 22px 16px;
      font-size: 16px;
      font-weight: 900;
      color: #1565c0;
    }

    .no-result{
      padding: 26px 16px;
      font-size: 16px;
      font-weight: 900;
      color: rgba(51, 65, 85, 0.9);
      line-height: 1.6;
    }

    /* ===== 모달 ===== */
    .detail-modal{
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(560px, 92vw);
      max-height: 85vh;
      overflow: auto;
      border: none;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 22px 70px rgba(0,0,0,0.42);
      background: #fff;
    }

    .detail-modal::backdrop{ background: rgba(0,0,0,0.55); }

    .modal-header{
      padding: 18px 20px 14px;
      background: #ffffff;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .modal-title-row{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .modal-title{
      font-size: 20px;
      font-weight: 900;
      color: #12335a;
    }

    .modal-actions{
      display: flex;
      gap: 8px;
    }

    .btn-print, .btn-close{
      padding: 10px 14px;
      border: 1px solid rgba(15, 23, 42, 0.14);
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
    }

    .btn-print{
      background: #1976D2;
      color: #fff;
      border-color: #1565c0;
      display: none;
    }

    .btn-close:hover{ background: rgba(241, 245, 249, 1); }
    .btn-print:hover{ background: #1565c0; }

    .modal-body{
      padding: 18px 22px 22px;
      text-align: left;
    }

    .info-grid{
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 14px 16px;
      align-items: baseline;
    }

    .info-label{
      font-size: 14px;
      font-weight: 900;
      color: rgba(51, 65, 85, 0.85);
      padding-top: 6px;
    }

    .info-value{
      font-size: 20px;
      font-weight: 900;
      color: #0f172a;
      line-height: 1.35;
      word-break: break-word;
    }

    .info-value.mono{
      font-family: "Malgun Gothic", "맑은 고딕", monospace;
    }

    .divider{
      grid-column: 1 / -1;
      height: 1px;
      background: rgba(15, 23, 42, 0.08);
      margin: 6px 0;
    }

    /* PC에서만 출력 버튼 */
    @media (min-width: 769px){
      .btn-print { display: inline-block; }
    }

    /* 모바일 키오스크 대응 */
    @media (max-width: 480px){
      body{ padding: 12px; }

      .header{ padding: 20px 18px 12px; }
      .title{ font-size: 26px; }

      .tabs{ padding: 0 18px; }
      .tab-btn{ font-size: 15px; padding: 14px 8px; }
      .tab-btn.active::after{ left: 22%; right: 22%; height: 5px; bottom: 7px; }

      .content{ padding: 14px 18px 18px; }
      .search-box{ grid-template-columns: 1fr; }
      .btn-search{ width: 100%; }

      th, td{ font-size: 14px; padding: 12px 10px; }
    }
  </style>
</head>

<body>
  <main>
    <div class="header">
      <div class="title">울산하늘공원 고인 검색</div>
      <div class="subnote">고인명을 입력한 뒤 검색을 눌러주세요.</div>

      <!-- 제목과 검색창 사이 탭 -->
      <div class="tabs" role="tablist" aria-label="검색 구분">
        <button type="button" class="tab-btn active" data-mode="all" onclick="setMode('all')">전체</button>
        <button type="button" class="tab-btn" data-mode="memorial" onclick="setMode('memorial')">추모의집</button>
        <button type="button" class="tab-btn" data-mode="nature" onclick="setMode('nature')">자연장지</button>
      </div>
    </div>

    <div class="content">
      <div class="input-label">고인명</div>

      <form id="searchForm" class="search-box">
        <div class="input-wrap">
          <input type="text" id="keyword" name="keyword" placeholder="예) 홍길동" required autocomplete="off" />
        </div>
        <button class="btn-search" type="submit">검색</button>
      </form>

      <div class="hint">※ 검색 결과 행을 누르면 상세 정보가 표시됩니다.</div>

      <div id="result"></div>
    </div>
  </main>

  <!-- 상세 모달 -->
  <dialog id="detailModal" class="detail-modal">
    <div class="modal-header">
      <div class="modal-title-row">
        <div class="modal-title">고인 위치 안내</div>
        <div class="modal-actions">
          <button type="button" class="btn-print" onclick="window.print()">출력</button>
          <button type="button" class="btn-close" onclick="document.getElementById('detailModal').close()">닫기</button>
        </div>
      </div>
    </div>

    <div class="modal-body">
      <div class="info-grid">
        <div class="info-label">고인명</div>
        <div class="info-value" id="modalName"></div>

        <div class="divider"></div>

        <div class="info-label" id="labelType" style="display:none;">구분</div>
        <div class="info-value" id="modalType" style="display:none;"></div>

        <div class="divider" id="dividerAfterType" style="display:none;"></div>

        <div class="info-label" id="labelLoc">봉안실</div>
        <div class="info-value mono" id="modalLoc"></div>

        <div class="divider"></div>

        <div class="info-label">신청자</div>
        <div class="info-value" id="modalApplicant"></div>

        <div class="divider"></div>

        <div class="info-label" id="labelDate">안치일자</div>
        <div class="info-value" id="modalDate"></div>
      </div>
    </div>
  </dialog>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    /* =========================
       데이터 소스 / 컬럼 매핑
       ========================= */
    const SOURCES = {
      memorial: 'data/deceased_data.xlsx',  // 추모의집
      nature:   'data/nature_data.xlsx'     // 자연장지
    };

    const MEM_FIELDS = {
      name: "사망자명",
      loc: "봉안번호",
      applicant: "신청자명",
      date: "안치일자",
      returned: "반환일자"
    };

    // 자연장지 엑셀 컬럼: 사망자명 / 자연장번호 / 신청자명 / 안치일자
    const NAT_FIELDS = {
      name: "사망자명",
      loc: "자연장번호",
      applicant: "신청자명",
      date: "안치일자"
    };

    /* =========================
       상태 / 캐시 / 지연 로딩
       ========================= */
    let currentMode = 'all';

    let excelDataMemorial = [];
    let excelDataNature = [];
    let loadPromiseMemorial = null;
    let loadPromiseNature = null;

    let lastFound = [];

    function setMode(mode){
      currentMode = mode;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });
      resetResultOnly();
      document.getElementById("keyword").focus();
    }

    async function fetchExcel(url){
      const response = await fetch(url);
      if (!response.ok) throw new Error('데이터 파일을 찾을 수 없습니다: ' + url);

      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    }

    async function ensureMemorialLoaded(){
      if (excelDataMemorial.length > 0) return;
      if (!loadPromiseMemorial){
        loadPromiseMemorial = fetchExcel(SOURCES.memorial)
          .then(data => { excelDataMemorial = data; })
          .finally(() => { loadPromiseMemorial = null; });
      }
      await loadPromiseMemorial;
    }

    async function ensureNatureLoaded(){
      if (excelDataNature.length > 0) return;
      if (!loadPromiseNature){
        loadPromiseNature = fetchExcel(SOURCES.nature)
          .then(data => { excelDataNature = data; })
          .finally(() => { loadPromiseNature = null; });
      }
      await loadPromiseNature;
    }

    // 검색 시점 지연 로딩
    async function ensureDataForSearch(mode){
      if (mode === 'memorial'){
        await ensureMemorialLoaded();
        return { partialFail: [] };
      }
      if (mode === 'nature'){
        await ensureNatureLoaded();
        return { partialFail: [] };
      }

      const partialFail = [];
      await Promise.all([
        ensureMemorialLoaded().catch(() => partialFail.push('추모의집')),
        ensureNatureLoaded().catch(() => partialFail.push('자연장지'))
      ]);

      if (excelDataMemorial.length === 0 && excelDataNature.length === 0){
        throw new Error('전체 데이터 로딩 실패');
      }
      return { partialFail };
    }

    /* =========================
       유틸
       ========================= */
    function normalizeRoom(raw) {
      if (!raw) return "";
      const s = String(raw).replace(/\s+/g, "");
      const exact = s.match(/^(\d{2})실(\d{5})$/);
      if (exact) return `${exact[1]}실 ${exact[2]}`;
      const room = s.match(/(\d{2})실/);
      const digits = s.replace(/\D/g, "");
      const last5 = digits.slice(-5);
      if (room && last5.length === 5) return `${room[1]}실 ${last5}`;
      return String(raw);
    }

    // 자연장번호: "잔디장-1-1-001" → "잔디장 - 1 - 1 - 001"
    function normalizeNatureNo(raw){
      if (!raw) return "";
      const s = String(raw).trim();
      return s.split("-").map(p => p.trim()).filter(Boolean).join(" - ");
    }

    function maskName(name) {
      if (!name) return "";
      const trimmed = String(name).substring(0, 3);
      if (trimmed.length === 1) return trimmed;
      if (trimmed.length === 2) return trimmed[0] + "*";
      if (trimmed.length === 3) return trimmed[0] + "*" + trimmed[2];
      return trimmed;
    }

    function getHeaderLabels(mode) {
      if (mode === 'nature'){
        return { name: "고인명", loc: "안장번호", applicant: "신청자", date: "안장일자" };
      }
      if (mode === 'memorial'){
        return { name: "고인명", loc: "봉안실", applicant: "신청자", date: "안치일자" };
      }
      return { name: "고인명", loc: "위치번호", applicant: "신청자", date: "일자" };
    }

    function openModal(record) {
      document.getElementById("modalName").textContent = record.name || "";
      document.getElementById("modalLoc").textContent = record.location || "";
      document.getElementById("modalApplicant").textContent = record.applicant || "";
      document.getElementById("modalDate").textContent = record.date || "";

      document.getElementById("labelLoc").textContent = record.locationLabel || "위치번호";
      document.getElementById("labelDate").textContent = record.dateLabel || "일자";

      const showType = (currentMode === 'all' && record.typeLabel);
      document.getElementById("labelType").style.display = showType ? "block" : "none";
      document.getElementById("modalType").style.display = showType ? "block" : "none";
      document.getElementById("dividerAfterType").style.display = showType ? "block" : "none";
      if (showType) document.getElementById("modalType").textContent = record.typeLabel;

      document.getElementById("detailModal").showModal();
    }

    function bindTableClick() {
      const table = document.querySelector("#result table");
      if (!table) return;

      table.addEventListener("click", function(e) {
        const tr = e.target.closest("tr[data-idx]");
        if (!tr) return;

        const idx = Number(tr.dataset.idx);
        const rec = lastFound[idx];
        if (!rec) return;

        openModal(rec);
      });
    }

    document.getElementById("detailModal").addEventListener("click", function(e) {
      const rect = this.getBoundingClientRect();
      const isInDialog =
        rect.top <= e.clientY && e.clientY <= rect.bottom &&
        rect.left <= e.clientX && e.clientX <= rect.right;
      if (!isInDialog) this.close();
    });

    /* =========================
       검색
       ========================= */
    function searchMemorial(keyword){
      return excelDataMemorial
        .filter(row =>
          row[MEM_FIELDS.name] &&
          String(row[MEM_FIELDS.name]).includes(keyword) &&
          !row[MEM_FIELDS.returned]
        )
        .map(row => ({
          type: 'memorial',
          typeLabel: '추모의집',
          name: row[MEM_FIELDS.name] || "",
          location: normalizeRoom(row[MEM_FIELDS.loc] || ""),
          applicant: maskName(row[MEM_FIELDS.applicant]),
          date: row[MEM_FIELDS.date] || "",
          locationLabel: "봉안실",
          dateLabel: "안치일자"
        }));
    }

    function searchNature(keyword){
      return excelDataNature
        .filter(row =>
          row[NAT_FIELDS.name] &&
          String(row[NAT_FIELDS.name]).includes(keyword)
        )
        .map(row => ({
          type: 'nature',
          typeLabel: '자연장지',
          name: row[NAT_FIELDS.name] || "",
          location: normalizeNatureNo(row[NAT_FIELDS.loc] || ""),
          applicant: maskName(row[NAT_FIELDS.applicant]),
          date: row[NAT_FIELDS.date] || "",
          locationLabel: "안장번호",
          dateLabel: "안장일자"
        }));
    }

    function renderResults(records, keyword){
      const resultDiv = document.getElementById("result");
      const h = getHeaderLabels(currentMode);

      if (!records || records.length === 0){
        resultDiv.innerHTML = `<div class="no-result">‘${keyword}’에 대한 검색 결과가 없습니다.</div>`;
        return;
      }

      const titleLeft = `${(currentMode==='all'?'전체':(currentMode==='memorial'?'추모의집':'자연장지'))} 검색 결과 ${records.length}건`;
      const titleRight = `행을 누르면 상세 정보`;

      let html = `
        <div class="result-head">
          <div class="result-title">${titleLeft}</div>
          <div class="result-sub">${titleRight}</div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width:20%">${h.name}</th>
                <th style="width:35%">${h.loc}</th>
                <th style="width:20%">${h.applicant}</th>
                <th style="width:25%">${h.date}</th>
              </tr>
            </thead>
            <tbody>
      `;

      records.forEach((rec, idx) => {
        html += `
          <tr data-idx="${idx}">
            <td>${rec.name}</td>
            <td class="col-loc">${rec.location}</td>
            <td>${rec.applicant}</td>
            <td>${rec.date}</td>
          </tr>
        `;
      });

      html += `</tbody></table></div>`;
      resultDiv.innerHTML = html;
      bindTableClick();
    }

    document.getElementById("searchForm").addEventListener("submit", async function(event) {
      event.preventDefault();

      const keyword = document.getElementById("keyword").value.trim();
      const resultDiv = document.getElementById("result");

      if (!keyword) return;

      resultDiv.style.display = "block";
      resultDiv.innerHTML = `<div class="loading">데이터를 불러오고 있습니다...</div>`;

      try{
        await ensureDataForSearch(currentMode);
      }catch(err){
        resultDiv.innerHTML = `<div class="no-result">데이터 파일을 불러올 수 없습니다.<br>관리자에게 문의하세요.</div>`;
        return;
      }

      let found = [];
      if (currentMode === 'memorial') found = searchMemorial(keyword);
      else if (currentMode === 'nature') found = searchNature(keyword);
      else {
        if (excelDataMemorial.length > 0) found.push(...searchMemorial(keyword));
        if (excelDataNature.length > 0) found.push(...searchNature(keyword));
      }

      lastFound = found;
      renderResults(found, keyword);
    });

    function resetResultOnly(){
      const resultDiv = document.getElementById("result");
      resultDiv.style.display = "none";
      resultDiv.innerHTML = "";
      lastFound = [];
    }

    // 첫 화면용 리셋(요청 시에만 쓰고 싶으면 버튼 추가 가능)
    // function resetView(){ ... }
  </script>
</body>
</html>
