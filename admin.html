<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>울산하늘공원 데이터 관리자 (웹 편집)</title>

  <!-- Handsontable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f6f2ec;
      color: #2f2a25;
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 1200px;
    }
    h1 {
      margin: 0 0 18px;
      font-size: 22px;
      color: #3a332e;
      text-align: center;
    }

    .config-box {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      background: #fff;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin: 10px 0 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-load { background-color: #3a332e; color: #fff; }
    .btn-load:hover { background-color: #524a42; }
    .btn-save { background-color: #27ae60; color: #fff; }
    .btn-save:hover { background-color: #219150; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }

    /* ✅ A1만 보이는 문제 해결: overflow hidden 금지 */
    #hotContainer {
      width: 100%;
      height: 600px;
      overflow: auto;            /* ✅ 스크롤 허용 */
      border: 1px solid #dcdcdc;
      border-radius: 4px;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      display: none;
      white-space: pre-wrap;
    }
    .status.success { background: #e0f5f0; color: #1d7c6b; }
    .status.error { background: #fdeaea; color: #b92b27; }
    .status.loading { background: #f0f0f0; color: #555; }

    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #777;
      line-height: 1.4;
    }
    .hint code {
      background: #f3f3f3;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .mini {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
      line-height: 1.35;
    }
    .file-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f3f3f3;
      border: 1px solid #e4e4e4;
      font-size: 12px;
      margin-left: 6px;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>
      봉안 데이터 관리자 (웹 편집)
      <span id="currentFileBadge" class="file-badge">-</span>
    </h1>

    <div class="config-box">
      <div class="form-group">
        <label>GitHub ID (owner)</label>
        <input type="text" id="owner" placeholder="예: ul-skypark" />
      </div>
      <div class="form-group">
        <label>저장소 이름 (repo)</label>
        <input type="text" id="repo" placeholder="예: ulsan-skypark-search" />
      </div>

      <!-- ✅ 파일 선택 쉽게: 2개 고정 + 직접 입력 -->
      <div class="form-group">
        <label>편집할 파일 선택</label>
        <select id="fileSelect" onchange="onFileSelectChange()">
          <option value="data/deceased_data.xlsx">data/deceased_data.xlsx (봉안/고인 데이터)</option>
          <option value="data/nature_data.xlsx">data/nature_data.xlsx (자연장 데이터)</option>
          <option value="custom">직접 입력</option>
        </select>
      </div>

      <div class="form-group">
        <label>파일 경로 (repo 기준)</label>
        <input type="text" id="path" value="data/deceased_data.xlsx" />
        <div class="mini">예: <code>data/deceased_data.xlsx</code></div>
      </div>

      <!-- ✅ 브랜치는 main 고정(요청사항) -->
      <div class="form-group">
        <label>브랜치</label>
        <input type="text" id="branch" value="main" readonly />
        <div class="mini">현재 페이지는 main 브랜치 기준으로 동작</div>
      </div>

      <div class="form-group">
        <label>Access Token</label>
        <input type="password" id="token" placeholder="ghp_... 또는 fine-grained token" />
        <div class="mini">토큰은 로컬 저장됨(브라우저). 공유/노출 주의</div>
      </div>
    </div>

    <div class="toolbar">
      <button id="loadBtn" class="btn btn-load" onclick="loadFile()">엑셀 불러오기</button>
      <button id="saveBtn" class="btn btn-save" onclick="saveFile()" disabled>변경사항 저장하기</button>
    </div>

    <div id="statusMsg" class="status"></div>
    <div id="hotContainer"></div>

    <div class="hint">
      GitHub 파일 주소에 <code>blob/main</code> 같은 건 넣지 말고, 저장소 기준 경로만 넣으면 돼.
      예: <code>data/deceased_data.xlsx</code>
    </div>
  </div>

  <script>
    let hot = null;
    let currentSha = "";
    let isDirty = false;

    // main 고정
    const BRANCH = "main";

    // 편의: 저장된 기본값 (원하면 여기 owner/repo 기본값 박아도 됨)
    // const DEFAULT_OWNER = "ul-skypark";
    // const DEFAULT_REPO  = "ulsan-skypark-search";

    window.onload = () => {
      // 로컬 저장값 불러오기
      const savedOwner = localStorage.getItem('gh_owner');
      const savedRepo  = localStorage.getItem('gh_repo');
      const savedPath  = localStorage.getItem('gh_path');
      const savedToken = localStorage.getItem('gh_token');
      const savedFileSelect = localStorage.getItem('gh_fileSelect');

      if (savedOwner) document.getElementById('owner').value = savedOwner;
      if (savedRepo)  document.getElementById('repo').value  = savedRepo;
      if (savedToken) document.getElementById('token').value = savedToken;

      // 브랜치 고정
      document.getElementById('branch').value = BRANCH;

      if (savedFileSelect) {
        document.getElementById('fileSelect').value = savedFileSelect;
      }

      // fileSelect에 맞춰 path 동기화
      const sel = document.getElementById('fileSelect').value;
      if (sel !== 'custom') {
        document.getElementById('path').value = sel;
      } else if (savedPath) {
        document.getElementById('path').value = savedPath;
      }

      onFileSelectChange(true);
      updateCurrentFileBadge();
    };

    function updateCurrentFileBadge() {
      const badge = document.getElementById('currentFileBadge');
      const path = document.getElementById('path').value.trim();
      badge.textContent = path ? path : "-";
    }

    function onFileSelectChange(isInit = false) {
      const sel = document.getElementById('fileSelect').value;
      const pathInput = document.getElementById('path');

      if (sel === 'custom') {
        pathInput.disabled = false;
        if (!isInit) pathInput.focus();
      } else {
        pathInput.value = sel;
        pathInput.disabled = true;
      }

      localStorage.setItem('gh_fileSelect', sel);
      localStorage.setItem('gh_path', pathInput.value.trim());
      updateCurrentFileBadge();
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = 'status ' + type;
      el.style.display = 'block';
      if (type === 'success') {
        setTimeout(() => { el.style.display = 'none'; }, 3000);
      }
    }

    function setSaveEnabled(enabled) {
      document.getElementById('saveBtn').disabled = !enabled;
    }

    // base64(content) -> Uint8Array (줄바꿈 제거)
    function base64ToUint8Array(base64) {
      const clean = base64.replace(/\s/g, '');
      const binaryString = atob(clean);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      return bytes;
    }

    // Uint8Array -> base64 (대용량도 안전하게 chunk 처리)
    function uint8ArrayToBase64(u8) {
      let binary = '';
      const chunkSize = 0x8000; // 32KB
      for (let i = 0; i < u8.length; i += chunkSize) {
        const chunk = u8.subarray(i, i + chunkSize);
        binary += String.fromCharCode.apply(null, chunk);
      }
      return btoa(binary);
    }

    function getInputs() {
      const owner = document.getElementById('owner').value.trim();
      const repo  = document.getElementById('repo').value.trim();
      const path  = document.getElementById('path').value.trim();
      const token = document.getElementById('token').value.trim();
      return { owner, repo, path, token, branch: BRANCH };
    }

    function saveInputsToLocalStorage({owner, repo, path, token}) {
      localStorage.setItem('gh_owner', owner);
      localStorage.setItem('gh_repo', repo);
      localStorage.setItem('gh_path', path);
      localStorage.setItem('gh_token', token);
    }

    function buildContentsUrl(owner, repo, path, branch) {
      // branch main 고정으로 ref 붙여서 확실히
      return `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}?ref=${encodeURIComponent(branch)}`;
    }

    async function loadFile() {
      const { owner, repo, path, token, branch } = getInputs();

      if (!owner || !repo || !path || !token) {
        showStatus('모든 설정값(Owner/Repo/Path/Token)을 입력해주세요.', 'error');
        return;
      }

      saveInputsToLocalStorage({owner, repo, path, token});
      updateCurrentFileBadge();

      showStatus('GitHub에서 파일 불러오는 중...', 'loading');
      document.getElementById('loadBtn').disabled = true;
      setSaveEnabled(false);
      isDirty = false;

      try {
        const apiUrl = buildContentsUrl(owner, repo, path, branch);
        const res = await fetch(apiUrl, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json"
          }
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`불러오기 실패 (${res.status})\n${txt}`);
        }

        const data = await res.json();

        // 폴더면 배열
        if (Array.isArray(data)) {
          throw new Error(
            "현재 경로가 폴더로 인식됐어.\n" +
            "반드시 .xlsx까지 포함한 파일 경로로 입력해줘.\n\n" +
            "예) data/deceased_data.xlsx"
          );
        }

        currentSha = data.sha || "";

        // ✅ 핵심: content가 없으면 download_url로 ArrayBuffer 로드
        let fileBytes = null;

        if (data.content) {
          fileBytes = base64ToUint8Array(data.content);
        } else if (data.download_url) {
          const fileRes = await fetch(data.download_url, {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Accept": "application/octet-stream"
            }
          });
          if (!fileRes.ok) {
            const txt = await fileRes.text();
            throw new Error(`다운로드 URL로 로드 실패 (${fileRes.status})\n${txt}`);
          }
          const buf = await fileRes.arrayBuffer();
          fileBytes = new Uint8Array(buf);
        } else {
          throw new Error(
            "GitHub 응답에 content/download_url이 없어.\n" +
            "경로/권한/브랜치를 확인해줘."
          );
        }

        // 엑셀 파싱
        const wb = XLSX.read(fileBytes, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        initGrid(aoa);

        showStatus('파일 로드 완료! 데이터를 수정하세요.', 'success');
        setSaveEnabled(false);

      } catch (err) {
        showStatus(err.message, 'error');
      } finally {
        document.getElementById('loadBtn').disabled = false;
      }
    }

    function initGrid(aoa) {
      const container = document.getElementById('hotContainer');
      container.innerHTML = '';

      // 첫 행을 헤더로 사용 (헤더는 편집에서 제외)
      const headers  = (aoa && aoa.length > 0) ? aoa[0] : [];
      const bodyData = (aoa && aoa.length > 1) ? aoa.slice(1) : [];

      hot = new Handsontable(container, {
        data: bodyData,
        rowHeaders: true,
        colHeaders: headers,
        height: 600,        // ✅ 레이아웃 꼬임 방지
        width: '100%',
        stretchH: 'all',
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: true,
        manualColumnResize: true,
        manualRowResize: true,
        filters: true,
        dropdownMenu: true,
        afterChange: (changes, source) => {
          if (!changes) return;
          if (source === 'loadData') return;
          isDirty = true;
          setSaveEnabled(true);
        }
      });

      // ✅ A1만 보이는 현상 방지
      setTimeout(() => {
        if (hot) {
          hot.render();
          hot.refreshDimensions();
        }
      }, 0);
    }

    async function saveFile() {
      if (!hot) return;

      const { owner, repo, path, token, branch } = getInputs();

      if (!owner || !repo || !path || !token) {
        showStatus('설정값(Owner/Repo/Path/Token)이 누락됐어.', 'error');
        return;
      }

      if (!isDirty) {
        showStatus('변경된 내용이 없어.', 'success');
        return;
      }

      if (!confirm("정말 수정사항을 GitHub에 저장하시겠습니까?")) return;

      showStatus('GitHub에 저장 중...', 'loading');
      setSaveEnabled(false);

      try {
        // 헤더 + 본문 합쳐서 다시 저장
        const headers = hot.getColHeader();
        const body = hot.getData();
        const merged = [headers, ...body];

        const newWs = XLSX.utils.aoa_to_sheet(merged);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, newWs, "Sheet1");

        const wbOut = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
        const bytes = new Uint8Array(wbOut);
        const contentBase64 = uint8ArrayToBase64(bytes);

        const apiUrl = buildContentsUrl(owner, repo, path, branch);

        const putBody = {
          message: `Update data via Admin Page: ${new Date().toISOString()}`,
          content: contentBase64,
          sha: currentSha,
          branch: branch
        };

        const res = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(putBody)
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`저장 실패 (${res.status})\n${txt}`);
        }

        const resData = await res.json();
        currentSha = resData.content?.sha || currentSha;
        isDirty = false;

        showStatus('성공적으로 저장되었습니다! (반영까지 1~2분 소요)', 'success');

      } catch (err) {
        showStatus(err.message, 'error');
        setSaveEnabled(true);
      }
    }
  </script>
</body>
</html>
